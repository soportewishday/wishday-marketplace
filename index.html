<!DOCTYPE html>
<html>
<head>
<title>MiniTienda</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:#f5f5f5}
.h{background:#2c3e50;color:white;padding:1rem;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:1.5rem;font-weight:bold}
.nav{display:flex;gap:0.5rem}
.nav button,.nav select{background:#3498db;color:white;border:none;padding:0.5rem;border-radius:4px;cursor:pointer}
.nav button:hover{background:#2980b9}
.c{max-width:1200px;margin:0 auto;padding:2rem}
.hidden{display:none !important}
.fg{margin-bottom:1rem}
.fg label{display:block;margin-bottom:0.25rem;font-weight:bold}
.fg input,.fg textarea{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px}
.fg select{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;background:white}
.password-container{position:relative}
.password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:#7f8c8d;font-size:1.2rem;user-select:none}
.phone-container{display:flex;gap:0.5rem}
.phone-container select{flex:0 0 120px}
.phone-container input{flex:1}
.btn{background:#27ae60;color:white;border:none;padding:0.75rem 1rem;border-radius:4px;cursor:pointer;margin:0.5rem 0.5rem 0.5rem 0}
.btn:hover{background:#229954}
.btn-danger{background:#e74c3c}
.btn-paypal{background:#ffc439;color:#003087;text-decoration:none;display:inline-block;text-align:center}
.btn-paypal-cart{background:#0070ba;color:white;font-size:1.1rem;padding:1rem 2rem}
.products{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-top:2rem}
.product{background:white;border-radius:8px;padding:1rem;box-shadow:0 2px 4px rgba(0,0,0,0.1);cursor:pointer;transition:transform 0.2s}
.product:hover{transform:scale(1.02)}
.product h3{color:#2c3e50;margin-bottom:0.5rem}
.product p{color:#7f8c8d;margin-bottom:1rem}
.price{font-size:1.25rem;font-weight:bold;color:#27ae60;margin-bottom:1rem}
.pb{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem}
.pi{width:100%;height:200px;object-fit:cover;border-radius:4px;margin-bottom:1rem;background:#ecf0f1;display:flex;align-items:center;justify-content:center;color:#7f8c8d}
.ci{background:white;padding:1rem;margin-bottom:0.5rem;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
.ct{background:#34495e;color:white;padding:1rem;border-radius:4px;margin-top:1rem;text-align:right}
.ct .payment-options{display:flex;gap:1rem;justify-content:flex-end;align-items:center;margin-top:1rem;flex-wrap:wrap}
.ap{background:#8e44ad;color:white;padding:2rem;border-radius:8px;margin-top:2rem}
.af{background:#9b59b6;padding:1rem;border-radius:4px;margin-top:1rem}
.ui{background:#3498db;color:white;padding:1rem;border-radius:4px;margin-bottom:1rem}
.alert{padding:1rem;margin-bottom:1rem;border-radius:4px}
.alert-success{background:#d4edda;color:#155724}
.alert-error{background:#f8d7da;color:#721c24}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
.mc{background:white;padding:2rem;width:90%;max-width:600px;border-radius:8px;position:relative}
.cb{position:absolute;top:1rem;right:1.5rem;font-size:2rem;cursor:pointer;color:#7f8c8d}
.image-upload{position:relative;display:inline-block;width:100%}
.image-upload input[type=file]{position:absolute;left:-9999px}
.image-upload label{display:block;padding:0.75rem;background:#3498db;color:white;border-radius:4px;cursor:pointer;text-align:center;transition:background 0.3s}
.image-upload label:hover{background:#2980b9}
.image-preview{width:100%;height:200px;border:2px dashed #ddd;border-radius:4px;display:flex;align-items:center;justify-content:center;margin-top:0.5rem;background:#f8f9fa;position:relative;overflow:hidden}
.image-preview img{width:100%;height:100%;object-fit:cover;border-radius:4px}
.image-preview .placeholder{color:#7f8c8d;text-align:center}
.remove-image{position:absolute;top:5px;right:5px;background:#e74c3c;color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:12px}
.cart-limit{color:#e74c3c;font-size:0.9rem;margin-top:0.5rem}
.paypal-config{background:#f8f9fa;padding:1rem;border-radius:4px;margin-top:1rem;border-left:4px solid #0070ba}
.email-config{background:#f8f9fa;padding:1rem;border-radius:4px;margin-top:1rem;border-left:4px solid #e67e22}
#paypal-button-container{margin-top:1rem}
#single-paypal-container{margin-top:1rem}
</style>
</head>
<body>
<div class="h">
<div class="logo">üõí <span id="sn">MiniTienda</span></div>
<div class="nav">
<button onclick="showSection('tienda')" id="sb">Tienda</button>
<button onclick="showSection('carrito')"><span id="cb">Carrito</span> (<span id="cc">0</span>)</button>
<button id="lb" onclick="showSection('login')">Login</button>
<button id="ob" onclick="logout()" class="hidden">Logout</button>
<button id="ab" onclick="showSection('admin')" class="hidden">Admin</button>
<select id="ls" onchange="changeLang()">
<option value="es">üá™üá∏</option>
<option value="en">üá∫üá∏</option>
</select>
<select id="cs" onchange="changeCurr()">
<option value="USD">$</option>
<option value="CRC">‚Ç°</option>
</select>
</div>
</div>

<div class="c">
<div id="alertContainer"></div>
<div id="userInfo" class="ui hidden">
<span id="wt"></span>
</div>

<div id="tienda">
<h2 id="pt">Productos Disponibles</h2>
<div class="products" id="pg"></div>
</div>

<div id="carrito" class="hidden">
<h2 id="ct2">Mi Carrito</h2>
<div id="ci2"></div>
<div class="ct">
<strong><span id="tt">Total</span>: <span id="sy2">$</span><span id="tp">0</span></strong>
<div class="cart-limit">
<span id="cl">M√°ximo 15 productos en el carrito</span> - <span id="current-items">0</span>/15
</div>
<div class="payment-options">
<button class="btn btn-paypal-cart" onclick="triggerPayPalCheckout()" id="buy-now-btn">üõí Comprar Ahora</button>
<div id="paypal-button-container"></div>
</div>
</div>
</div>

<div id="login" class="hidden">
<h2 id="lt">Login</h2>
<div class="fg">
<label>Email:</label>
<input type="email" id="le" placeholder="email@email.com">
</div>
<div class="fg">
<label id="pl">Password:</label>
<div class="password-container">
<input type="password" id="lp">
<span class="password-toggle" onclick="togglePassword('lp', this)">üëÅÔ∏è</span>
</div>
</div>
<button class="btn" onclick="login()" id="lab">Login</button>
<button class="btn" onclick="showSection('registro')" id="cb3">Crear</button>
</div>

<div id="registro" class="hidden">
<h2 id="rt">Registro</h2>
<div class="fg">
<label id="nl">Nombre:</label>
<input type="text" id="rn">
</div>
<div class="fg">
<label>Email:</label>
<input type="email" id="re">
</div>
<div class="fg">
<label id="phone-label">Tel√©fono:</label>
<div class="phone-container">
<select id="country-code">
<option value="+506" selected>üá®üá∑ +506</option>
<option value="+34">üá™üá∏ +34</option>
<option value="+507">üáµüá¶ +507</option>
<option value="+505">üá≥üáÆ +505</option>
</select>
<input type="tel" id="rph" placeholder="8888-8888" required>
</div>
</div>
<div class="fg">
<label id="cedula-label">C√©dula/ID:</label>
<input type="text" id="cedula" placeholder="1-1234-5678" required>
</div>
<div class="fg">
<label id="address-label">Direcci√≥n de Env√≠o:</label>
<textarea id="address" placeholder="Direcci√≥n completa para env√≠os..." rows="3" required></textarea>
</div>
<div class="fg">
<label id="pl2">Password:</label>
<div class="password-container">
<input type="password" id="rp" required>
<span class="password-toggle" onclick="togglePassword('rp', this)">üëÅÔ∏è</span>
</div>
</div>
<button class="btn" onclick="register()" id="rb">Crear</button>
</div>

<div id="admin" class="hidden ap">
<h2 id="at">Admin Panel</h2>

<div class="af paypal-config">
<h3>ü™ô Configuraci√≥n PayPal</h3>
<div class="fg">
<label>Client ID:</label>
<input type="text" id="paypal-client-id" placeholder="Tu PayPal Client ID" value="ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn">
</div>
<div class="fg">
<label>Modo:</label>
<select id="paypal-mode">
<option value="live">Live (Producci√≥n)</option>
<option value="sandbox">Sandbox (Pruebas)</option>
</select>
</div>
<button class="btn" onclick="savePayPalConfig()">üíæ Guardar Configuraci√≥n</button>
</div>

<div class="af email-config">
<h3>üìß Configuraci√≥n de Email</h3>
<div class="fg">
<label>Tu Email (donde recibir√°s las notificaciones):</label>
<input type="email" id="admin-email" placeholder="admin@mitienda.com" value="admin@mitienda.com">
</div>
<div class="fg">
<label>Servicio de Email:</label>
<select id="email-service">
<option value="emailjs">EmailJS (Recomendado - Gratis)</option>
<option value="formspree">Formspree (Alternativa)</option>
<option value="webhook">Webhook Personalizado</option>
</select>
</div>
<div class="fg">
<label>EmailJS Service ID:</label>
<input type="text" id="emailjs-service" placeholder="service_xxxxxxx">
</div>
<div class="fg">
<label>EmailJS Template ID:</label>
<input type="text" id="emailjs-template" placeholder="template_xxxxxxx">
</div>
<div class="fg">
<label>EmailJS Public Key:</label>
<input type="text" id="emailjs-public-key" placeholder="xxxxxxxxxxxxxxxxx">
</div>
<button class="btn" onclick="saveEmailConfig()">üíæ Guardar Email Config</button>
<button class="btn" onclick="testEmail()" style="background:#e67e22;">üß™ Probar Email</button>
</div>

<div class="af">
<h3 id="apt">Agregar Producto</h3>
<div class="fg">
<label>Nombre:</label>
<input type="text" id="apn">
</div>
<div class="fg">
<label>Descripci√≥n:</label>
<input type="text" id="apd">
</div>
<div class="fg">
<label>Precio USD:</label>
<input type="number" id="app">
</div>
<div class="fg">
<label>Imagen del Producto:</label>
<div class="image-upload">
<input type="file" id="product-image" accept="image/*" onchange="previewImage(this, 'image-preview')">
<label for="product-image">üì∑ Seleccionar Imagen</label>
</div>
<div class="image-preview" id="image-preview">
<div class="placeholder">üì¶ Vista previa de la imagen</div>
</div>
</div>
<div class="fg">
<label>Imagen URL (opcional):</label>
<input type="url" id="api" placeholder="https://ejemplo.com/imagen.jpg">
</div>
<div class="fg">
<label>PayPal Individual (opcional):</label>
<input type="url" id="apy" placeholder="https://paypal.me/usuario/precio">
</div>
<button class="btn" onclick="addProduct()" id="apb">Agregar</button>
</div>
<div class="af">
<h3>üìä Estad√≠sticas</h3>
<p>Productos: <span id="tps">0</span></p>
<p>Usuarios: <span id="tus">0</span></p>
<p>Ventas: <span id="sy3">$</span><span id="ts">0</span></p>
<p>PayPal: <span id="paypal-status">‚úÖ Configurado</span></p>
<p>Email: <span id="email-status">‚ùå No configurado</span></p>
</div>
</div>

<div id="modal" class="modal hidden">
<div class="mc">
<span class="cb" onclick="closeModal()">&times;</span>
<div id="mc2"></div>
</div>
</div>
</div>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn&currency=USD"></script>

<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
let lang='es',curr='USD',rate=510;
let users=[{id:1,name:"Admin",email:"admin@tienda.com",password:"admin123",role:"admin",phone:"+506-8888-8888",cedula:"Admin",address:"Admin Address"}];
let products=[
{id:1,name:"Laptop",desc:"Gaming laptop",price:899.99,paypalUrl:"https://paypal.me/shop/899",imageUrl:"https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=400&h=300&fit=crop"},
{id:2,name:"Mouse",desc:"RGB mouse",price:49.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?w=400&h=300&fit=crop"},
{id:3,name:"Keyboard",desc:"Mechanical",price:79.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1541140532154-b024d705b90a?w=400&h=300&fit=crop"},
{id:4,name:"Monitor",desc:"4K 27 inch",price:329.99,paypalUrl:"https://paypal.me/shop/329",imageUrl:"https://images.unsplash.com/photo-1527443224154-c4a3942d3acf?w=400&h=300&fit=crop"}
];
let cart=[],user=null,sales=0;
let paypalConfig = {clientId: 'ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn', mode: 'live'};
let emailConfig = {
    adminEmail: 'admin@mitienda.com',
    service: 'emailjs',
    emailjsServiceId: '',
    emailjsTemplateId: '',
    emailjsPublicKey: ''
};

const t={
es:{sn:'MiniTienda',sb:'Tienda',cb:'Carrito',lb:'Login',ob:'Logout',pt:'Productos',ct2:'Carrito',tt:'Total',lt:'Login',pl:'Contrase√±a',lab:'Login',cb3:'Crear',rt:'Registro',nl:'Nombre',rb:'Crear',at:'Admin',apt:'Agregar',apb:'Agregar',add:'Agregar',buy:'PayPal',edit:'Editar',del:'Eliminar',welcome:'Hola',noimg:'Sin imagen',cl:'M√°ximo 15 productos en el carrito',cartLimit:'No puedes agregar m√°s de 15 productos',itemsInCart:'productos en carrito',buyNow:'üõí Comprar Ahora','phone-label':'Tel√©fono','cedula-label':'C√©dula/ID','address-label':'Direcci√≥n de Env√≠o',buyDirect:'Comprar',directPayment:'O pagar directamente con PayPal:',buyWithCard:'Comprar con PayPal o Tarjeta'},
en:{sn:'MiniStore',sb:'Shop',cb:'Cart',lb:'Login',ob:'Logout',pt:'Products',ct2:'Cart',tt:'Total',lt:'Sign In',pl:'Password',lab:'Sign In',cb3:'Create',rt:'Register',nl:'Name',rb:'Create',at:'Admin',apt:'Add Product',apb:'Add',add:'Add',buy:'PayPal',edit:'Edit',del:'Delete',welcome:'Hello',noimg:'No image',cl:'Maximum 15 products in cart',cartLimit:'Cannot add more than 15 products',itemsInCart:'items in cart',buyNow:'üõí Buy Now','phone-label':'Phone','cedula-label':'ID Number','address-label':'Shipping Address',buyDirect:'Buy',directPayment:'Or pay directly with PayPal:',buyWithCard:'Buy with PayPal or Card'}
};

// Inicializar EmailJS si est√° configurado
function initEmailJS() {
    if (emailConfig.emailjsPublicKey) {
        emailjs.init(emailConfig.emailjsPublicKey);
        updateEmailStatus();
    }
}

// Funci√≥n para enviar email de notificaci√≥n de compra
async function sendPurchaseNotification(orderDetails) {
    console.log('=== DEBUG EMAIL ===');
    console.log('EmailJS Config:', emailConfig);
    console.log('Order Details:', orderDetails);
    
    if (!emailConfig.emailjsServiceId || !emailConfig.emailjsTemplateId || !emailConfig.emailjsPublicKey) {
        console.error('EmailJS no est√° configurado completamente');
        alert('EmailJS no configurado: Service=' + emailConfig.emailjsServiceId + ', Template=' + emailConfig.emailjsTemplateId + ', Key=' + (emailConfig.emailjsPublicKey ? 'OK' : 'MISSING'));
        return false;
    }

    try {
        const templateParams = {
            to_email: emailConfig.adminEmail,
            from_name: 'MiniTienda',
            customer_name: orderDetails.customerName,
            customer_email: orderDetails.customerEmail,
            customer_phone: orderDetails.customerPhone,
            customer_address: orderDetails.customerAddress,
            customer_cedula: orderDetails.customerCedula,
            order_id: orderDetails.orderId,
            order_date: orderDetails.orderDate,
            total_amount: orderDetails.totalAmount,
            currency: orderDetails.currency,
            items_list: orderDetails.itemsList,
            payment_method: 'PayPal',
            transaction_id: orderDetails.transactionId || 'N/A'
        };

        console.log('Template Params:', templateParams);
        console.log('Enviando email...');

        const response = await emailjs.send(
            emailConfig.emailjsServiceId,
            emailConfig.emailjsTemplateId,
            templateParams
        );

        console.log('‚úÖ Email enviado exitosamente:', response);
        return true;
    } catch (error) {
        console.error('‚ùå Error completo enviando email:');
        console.error('Error object:', error);
        console.error('Error status:', error.status);
        console.error('Error text:', error.text);
        console.error('Error message:', error.message);
        
        // Mostrar error m√°s espec√≠fico
        let errorMsg = 'Error desconocido';
        if (error.status === 422) {
            if (error.text) {
                errorMsg = 'Error 422: ' + error.text;
            } else {
                errorMsg = 'Error 422: Configuraci√≥n incorrecta (Service ID, Template ID o Public Key inv√°lidos)';
            }
        } else if (error.status === 400) {
            errorMsg = 'Error 400: Par√°metros incorrectos en el template';
        } else if (error.status === 401) {
            errorMsg = 'Error 401: Public Key incorrecta';
        }
        
        alert('Error EmailJS: ' + errorMsg);
        return false;
    }
}

// Funci√≥n para probar el env√≠o de email
async function testEmail() {
    const testOrder = {
        customerName: 'Cliente de Prueba',
        customerEmail: 'cliente@test.com',
        customerPhone: '+506-8888-8888',
        customerAddress: 'Direcci√≥n de prueba, San Jos√©, Costa Rica',
        customerCedula: '1-1234-5678',
        orderId: 'TEST-' + Date.now(),
        orderDate: new Date().toLocaleString(),
        totalAmount: '99.99',
        currency: 'USD',
        itemsList: 'Laptop Gaming x1 - $899.99\nMouse RGB x1 - $49.99',
        transactionId: 'TEST-TRANSACTION'
    };

    showAlert('Enviando email de prueba...', 'success');
    
    const success = await sendPurchaseNotification(testOrder);
    
    if (success) {
        showAlert('‚úÖ Email de prueba enviado exitosamente! Revisa tu bandeja de entrada.', 'success');
    } else {
        showAlert('‚ùå Error enviando email de prueba. Verifica la configuraci√≥n.', 'error');
    }
}

// Guardar configuraci√≥n de email
function saveEmailConfig() {
    emailConfig.adminEmail = document.getElementById('admin-email').value;
    emailConfig.service = document.getElementById('email-service').value;
    emailConfig.emailjsServiceId = document.getElementById('emailjs-service').value;
    emailConfig.emailjsTemplateId = document.getElementById('emailjs-template').value;
    emailConfig.emailjsPublicKey = document.getElementById('emailjs-public-key').value;

    if (emailConfig.emailjsPublicKey) {
        initEmailJS();
    }

    showAlert('‚úÖ Configuraci√≥n de email guardada!', 'success');
    updateEmailStatus();
}

// Actualizar estado del email
function updateEmailStatus() {
    const status = document.getElementById('email-status');
    if (emailConfig.emailjsServiceId && emailConfig.emailjsTemplateId && emailConfig.emailjsPublicKey) {
        status.innerHTML = '‚úÖ Configurado (EmailJS)';
        status.style.color = '#27ae60';
    } else {
        status.innerHTML = '‚ùå No configurado';
        status.style.color = '#e74c3c';
    }
}

// Resto de funciones originales...
function changeLang(){
lang=document.getElementById('ls').value;
updateTexts();
document.getElementById('buy-now-btn').textContent = t[lang].buyNow;
loadProducts();
updateCart();
}

function changeCurr(){
curr=document.getElementById('cs').value;
updateCurrency();
loadProducts();
updateCart();
updateUserInfo();
}

function updateTexts(){
Object.keys(t[lang]).forEach(k=>{
const el=document.getElementById(k);
if(el)el.textContent=t[lang][k];
});
document.getElementById('pl2').textContent=t[lang].pl;
}

function updateCurrency(){
const s=curr==='USD'?'$':'‚Ç°';
['sy','sy2','sy3'].forEach(id=>{
const el=document.getElementById(id);
if(el)el.textContent=s;
});
}

function formatPrice(p){
const c=curr==='CRC'?Math.round(p*rate).toLocaleString():p.toFixed(2);
return `${curr==='USD'?'$':'‚Ç°'}${c}`;
}

function showSection(s){
['tienda','carrito','login','registro','admin'].forEach(x=>document.getElementById(x).classList.add('hidden'));
document.getElementById(s).classList.remove('hidden');
if(s==='tienda')loadProducts();
if(s==='carrito'){updateCart();renderPayPalButton();}
if(s==='admin'&&user?.role==='admin')loadAdmin();
}

function loadProducts(){
const g=document.getElementById('pg');
g.innerHTML=products.map(p=>`
<div class="product" onclick="showDetail(${p.id})">
${p.imageUrl?`<img src="${p.imageUrl}" class="pi" onerror="this.style.display='none';">`:`<div class="pi">üì¶ ${t[lang].noimg}</div>`}
<h3>${p.name}</h3>
<p>${p.desc}</p>
<div class="price">${formatPrice(p.price)}</div>
<div class="pb" onclick="event.stopPropagation()">
<button class="btn" onclick="addToCart(${p.id})">üõí ${t[lang].add}</button>
${user?`<button class="btn btn-paypal-cart" onclick="showDetail(${p.id})" style="background:#0070ba;padding:0.5rem 0.8rem;font-size:0.85rem;">üí≥ ${t[lang].buyWithCard}</button>`:''}
${p.paypalUrl?`<a href="${p.paypalUrl}" class="btn btn-paypal" target="_blank" style="font-size:0.75rem;padding:0.4rem 0.6rem;">PayPal.me</a>`:''}
</div>
${user?.role==='admin'?`<div onclick="event.stopPropagation()">
<button class="btn" onclick="editProduct(${p.id})" style="background:#f39c12;font-size:0.8rem">‚úèÔ∏è ${t[lang].edit}</button>
<button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="font-size:0.8rem">üóëÔ∏è ${t[lang].del}</button>
</div>`:''}
</div>
`).join('');
}

function addToCart(id){
if(!user){
showAlert(lang==='es'?'Inicia sesi√≥n':'Sign in','error');
return;
}
const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
if(totalItems >= 15){
showAlert(t[lang].cartLimit,'error');
return;
}
const p=products.find(x=>x.id===id);
const e=cart.find(x=>x.id===id);
if(e)e.quantity+=1;
else cart.push({...p,quantity:1});
updateCartCount();
showAlert(`${p.name} ${lang==='es'?'agregado':'added'}`,'success');
}

function updateCart(){
const c=document.getElementById('ci2');
const total=cart.reduce((s,i)=>s+(i.price*i.quantity),0);
const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
c.innerHTML=cart.map(i=>`
<div class="ci">
<div><strong>${i.name}</strong> - ${formatPrice(i.price)} x ${i.quantity}</div>
<div>
<button class="btn" onclick="changeQty(${i.id},-1)">-</button>
<button class="btn" onclick="changeQty(${i.id},1)">+</button>
<button class="btn btn-danger" onclick="removeFromCart(${i.id})">${t[lang].del}</button>
</div>
</div>
`).join('');
document.getElementById('tp').textContent=curr==='CRC'?Math.round(total*rate).toLocaleString():total.toFixed(2);
document.getElementById('current-items').textContent=totalItems;
}

function changeQty(id,ch){
const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
if(ch > 0 && totalItems >= 15){
showAlert(t[lang].cartLimit,'error');
return;
}
const i=cart.find(c=>c.id===id);
if(i){
i.quantity+=ch;
if(i.quantity<=0)cart=cart.filter(c=>c.id!==id);
updateCart();
updateCartCount();
renderPayPalButton();
}
}

function removeFromCart(id){
cart=cart.filter(c=>c.id!==id);
updateCart();
updateCartCount();
renderPayPalButton();
}

function updateCartCount(){
document.getElementById('cc').textContent=cart.reduce((s,i)=>s+i.quantity,0);
}

function triggerPayPalCheckout(){
if(cart.length === 0){
showAlert(lang==='es'?'Carrito vac√≠o':'Cart empty','error');
return;
}
document.getElementById('buy-now-btn').style.display = 'none';
document.getElementById('paypal-button-container').style.display = 'block';
renderPayPalButton();
}

function renderPayPalButton(){
const container = document.getElementById('paypal-button-container');
if(!container) return;
container.innerHTML = '';
if(cart.length === 0) {
document.getElementById('buy-now-btn').style.display = 'block';
container.style.display = 'none';
return;
}

const total = cart.reduce((s,i)=>s+(i.price*i.quantity),0);
const paypalTotal = curr === 'CRC' ? (total / rate).toFixed(2) : total.toFixed(2);

if(window.paypal){
paypal.Buttons({
createOrder: function(data, actions) {
return actions.order.create({
purchase_units: [{
amount: {
value: paypalTotal,
currency_code: 'USD'
},
description: `${cart.length} ${t[lang].itemsInCart} - MiniTienda`
}]
});
},
onApprove: function(data, actions) {
return actions.order.capture().then(function(details) {
// Preparar datos para el email
const orderDetails = {
customerName: user.name,
customerEmail: user.email,
customerPhone: user.phone,
customerAddress: user.address,
customerCedula: user.cedula,
orderId: data.orderID,
orderDate: new Date().toLocaleString(),
totalAmount: paypalTotal,
currency: 'USD',
itemsList: cart.map(item => `${item.name} x${item.quantity} - $${item.price.toFixed(2)}`).join('\n'),
transactionId: details.id
};

// Enviar email de notificaci√≥n
sendPurchaseNotification(orderDetails);

sales += total;
cart = [];
updateCart();
updateCartCount();
document.getElementById('buy-now-btn').style.display = 'block';
document.getElementById('paypal-button-container').style.display = 'none';
showAlert(`${lang==='es'?'¬°Pago PayPal exitoso!':'PayPal payment successful!'} - ${details.payer.name.given_name}`, 'success');
if(user?.role==='admin') loadAdmin();
});
},
onCancel: function(data) {
document.getElementById('buy-now-btn').style.display = 'block';
document.getElementById('paypal-button-container').style.display = 'none';
showAlert(lang==='es'?'Pago cancelado':'Payment cancelled','error');
},
onError: function(err) {
document.getElementById('buy-now-btn').style.display = 'block';
document.getElementById('paypal-button-container').style.display = 'none';
showAlert(lang==='es'?'Error en el pago':'Payment error','error');
console.error('PayPal error:', err);
},
style: {
color: 'blue',
shape: 'rect',
label: 'paypal',
height: 50,
layout: 'vertical'
}
}).render('#paypal-button-container');
} else {
showAlert('PayPal no disponible','error');
}
}

function buyNowSingle(productId) {
const p = products.find(x => x.id === productId);
if (!p || !user) return;

const container = document.getElementById('single-paypal-container');
container.innerHTML = '';

const paypalTotal = curr === 'CRC' ? (p.price / rate).toFixed(2) : p.price.toFixed(2);

if(window.paypal){
paypal.Buttons({
createOrder: function(data, actions) {
return actions.order.create({
purchase_units: [{
amount: {
value: paypalTotal,
currency_code: 'USD'
},
description: `${p.name} - MiniTienda`
}]
});
},
onApprove: function(data, actions) {
return actions.order.capture().then(function(details) {
// Preparar datos para el email de compra individual
const orderDetails = {
customerName: user.name,
customerEmail: user.email,
customerPhone: user.phone,
customerAddress: user.address,
customerCedula: user.cedula,
orderId: data.orderID,
orderDate: new Date().toLocaleString(),
totalAmount: paypalTotal,
currency: 'USD',
itemsList: `${p.name} x1 - $${p.price.toFixed(2)}`,
transactionId: details.id
};

// Enviar email de notificaci√≥n
sendPurchaseNotification(orderDetails);

sales += p.price;
closeModal();
showAlert(`${lang==='es'?'¬°Compra exitosa!':'Purchase successful!'} - ${p.name}`, 'success');
if(user?.role==='admin') loadAdmin();
});
},
onCancel: function(data) {
showAlert(lang==='es'?'Pago cancelado':'Payment cancelled','error');
},
onError: function(err) {
showAlert(lang==='es'?'Error en el pago':'Payment error','error');
console.error('PayPal error:', err);
},
style: {
color: 'blue',
shape: 'rect',
label: 'paypal',
height: 40,
layout: 'horizontal'
}
}).render('#single-paypal-container');
} else {
showAlert('PayPal no disponible','error');
}
}

function savePayPalConfig(){
const clientId = document.getElementById('paypal-client-id').value;
const mode = document.getElementById('paypal-mode').value;
if(!clientId){
showAlert('Client ID requerido','error');
return;
}
paypalConfig = {clientId, mode};
document.getElementById('paypal-status').innerHTML = `‚úÖ Configurado (${mode})`;
showAlert(`Configuraci√≥n PayPal guardada - Modo: ${mode}. Recarga la p√°gina para aplicar cambios.`,'success');
}

function login(){
const email=document.getElementById('le').value;
const pass=document.getElementById('lp').value;
const u=users.find(x=>x.email===email&&x.password===pass);
if(u){
user=u;
updateUserInfo();
showSection('tienda');
showAlert(`${t[lang].welcome}, ${u.name}!`,'success');
}else{
showAlert(lang==='es'?'Credenciales incorrectas':'Wrong credentials','error');
}
}

function togglePassword(inputId, toggleIcon) {
const input = document.getElementById(inputId);
if (input.type === 'password') {
input.type = 'text';
toggleIcon.textContent = 'üôà';
} else {
input.type = 'password';
toggleIcon.textContent = 'üëÅÔ∏è';
}
}

function register(){
const name=document.getElementById('rn').value.trim();
const email=document.getElementById('re').value.trim();
const pass=document.getElementById('rp').value;
const countryCode=document.getElementById('country-code').value;
const phone=document.getElementById('rph').value.trim();
const cedula=document.getElementById('cedula').value.trim();
const address=document.getElementById('address').value.trim();

if(!name||!email||!pass||!phone||!cedula||!address){
showAlert(lang==='es'?'Todos los campos son requeridos':'All fields are required','error');
return;
}

if(users.find(u=>u.email===email)){
showAlert(lang==='es'?'Email ya existe':'Email already exists','error');
return;
}

const fullPhone = `${countryCode}-${phone}`;
const newUser = {
id:users.length+1,
name,
email,
password:pass,
role:'customer',
phone:fullPhone,
cedula,
address
};

users.push(newUser);
showAlert(lang==='es'?'¬°Cuenta creada exitosamente! Ya puedes iniciar sesi√≥n.':'Account created successfully! You can now sign in.','success');
showSection('login');

// Limpiar formulario
document.getElementById('rn').value='';
document.getElementById('re').value='';
document.getElementById('rp').value='';
document.getElementById('rph').value='';
document.getElementById('cedula').value='';
document.getElementById('address').value='';
}

function logout(){
user=null;
cart=[];
updateUserInfo();
updateCartCount();
showSection('tienda');
showAlert(lang==='es'?'Cerrado':'Logged out','success');
}

function updateUserInfo(){
if(user){
document.getElementById('userInfo').classList.remove('hidden');
document.getElementById('wt').textContent=`${t[lang].welcome}, ${user.name}`;
document.getElementById('lb').classList.add('hidden');
document.getElementById('ob').classList.remove('hidden');
if(user.role==='admin')document.getElementById('ab').classList.remove('hidden');
}else{
document.getElementById('userInfo').classList.add('hidden');
document.getElementById('lb').classList.remove('hidden');
document.getElementById('ob').classList.add('hidden');
document.getElementById('ab').classList.add('hidden');
}
}

function loadAdmin(){
document.getElementById('tps').textContent=products.length;
document.getElementById('tus').textContent=users.length-1;
document.getElementById('ts').textContent=curr==='CRC'?Math.round(sales*rate).toLocaleString():sales.toFixed(2);
document.getElementById('paypal-status').innerHTML = paypalConfig.clientId !== 'ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn' ? 
`‚úÖ Configurado (${paypalConfig.mode})` : '‚úÖ Configurado (live)';
updateEmailStatus();
}

function previewImage(input, previewId) {
const preview = document.getElementById(previewId);
const file = input.files[0];

if (file) {
const reader = new FileReader();
reader.onload = function(e) {
preview.innerHTML = `
<img src="${e.target.result}" alt="Preview">
<button class="remove-image" onclick="removeImage('${input.id}', '${previewId}')" title="Eliminar imagen">√ó</button>
`;
};
reader.readAsDataURL(file);
} else {
preview.innerHTML = '<div class="placeholder">üì¶ Vista previa de la imagen</div>';
}
}

function removeImage(inputId, previewId) {
document.getElementById(inputId).value = '';
document.getElementById(previewId).innerHTML = '<div class="placeholder">üì¶ Vista previa de la imagen</div>';
}

function convertImageToBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = () => resolve(reader.result);
reader.onerror = reject;
reader.readAsDataURL(file);
});
}

function addProduct(){
const name=document.getElementById('apn').value;
const desc=document.getElementById('apd').value;
const price=parseFloat(document.getElementById('app').value);
const urlImg=document.getElementById('api').value;
const paypal=document.getElementById('apy').value;
const fileInput=document.getElementById('product-image');

if(!name||!desc||!price){
showAlert('Required fields','error');
return;
}

if(fileInput.files[0]) {
convertImageToBase64(fileInput.files[0])
.then(base64Image => {
const newProduct = {
id: Date.now(),
name,
desc,
price,
imageUrl: base64Image,
paypalUrl: paypal || ''
};
products.push(newProduct);
clearProductForm();
showAlert('Producto agregado con imagen','success');
loadAdmin();
loadProducts();
})
.catch(error => {
console.error('Error convirtiendo imagen:', error);
showAlert('Error procesando imagen','error');
});
} else if(urlImg) {
const newProduct = {
id: Date.now(),
name,
desc,
price,
imageUrl: urlImg,
paypalUrl: paypal || ''
};
products.push(newProduct);
clearProductForm();
showAlert('Producto agregado con URL','success');
loadAdmin();
loadProducts();
} else {
const newProduct = {
id: Date.now(),
name,
desc,
price,
imageUrl: '',
paypalUrl: paypal || ''
};
products.push(newProduct);
clearProductForm();
showAlert('Producto agregado sin imagen','success');
loadAdmin();
loadProducts();
}
}

function clearProductForm() {
document.getElementById('apn').value='';
document.getElementById('apd').value='';
document.getElementById('app').value='';
document.getElementById('api').value='';
document.getElementById('apy').value='';
document.getElementById('product-image').value='';
document.getElementById('image-preview').innerHTML='<div class="placeholder">üì¶ Vista previa de la imagen</div>';
}

function editProduct(id){
const p=products.find(x=>x.id===id);
if(!p)return;
document.getElementById('apn').value=p.name;
document.getElementById('apd').value=p.desc;
document.getElementById('app').value=p.price;
document.getElementById('api').value=p.imageUrl.startsWith('data:') ? '' : p.imageUrl;
document.getElementById('apy').value=p.paypalUrl;

if(p.imageUrl) {
document.getElementById('image-preview').innerHTML = `
<img src="${p.imageUrl}" alt="Preview">
<button class="remove-image" onclick="removeImage('product-image', 'image-preview')" title="Eliminar imagen">√ó</button>
`;
}

document.getElementById('apb').onclick=()=>{
const fileInput=document.getElementById('product-image');
const urlImg=document.getElementById('api').value;

if(fileInput.files[0]) {
convertImageToBase64(fileInput.files[0])
.then(base64Image => {
p.name=document.getElementById('apn').value;
p.desc=document.getElementById('apd').value;
p.price=parseFloat(document.getElementById('app').value);
p.imageUrl=base64Image;
p.paypalUrl=document.getElementById('apy').value;
showAlert('Updated with new image','success');
loadProducts();
loadAdmin();
clearProductForm();
document.getElementById('apb').onclick=addProduct;
});
} else {
p.name=document.getElementById('apn').value;
p.desc=document.getElementById('apd').value;
p.price=parseFloat(document.getElementById('app').value);
p.imageUrl=urlImg || p.imageUrl;
p.paypalUrl=document.getElementById('apy').value;
showAlert('Updated','success');
loadProducts();
loadAdmin();
clearProductForm();
document.getElementById('apb').onclick=addProduct;
}
};
}

function deleteProduct(id){
if(confirm('Delete?')){
products=products.filter(p=>p.id!==id);
loadProducts();
loadAdmin();
showAlert('Deleted','success');
}
}

function showDetail(id){
const p=products.find(x=>x.id===id);
if(!p)return;
document.getElementById('mc2').innerHTML=`
<div style="text-align:center">
${p.imageUrl?`<img src="${p.imageUrl}" style="width:100%;max-height:300px;object-fit:contain;border-radius:4px;margin-bottom:1rem">`:`<div class="pi">üì¶ ${t[lang].noimg}</div>`}
<h2>${p.name}</h2>
<p>${p.desc}</p>
<div style="font-size:2rem;font-weight:bold;color:#27ae60;margin:1rem 0">${formatPrice(p.price)}</div>
<div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin-bottom:1rem">
${user?`<button class="btn" onclick="addToCart(${p.id});closeModal()">üõí ${t[lang].add}</button>`:`<p style="color:#e74c3c">${lang==='es'?'Inicia sesi√≥n':'Sign in'}</p>`}
${user?`<button class="btn btn-paypal-cart" onclick="buyNowSingle(${p.id})" style="background:#0070ba;">üí≥ ${t[lang].buyWithCard}</button>`:''}
</div>
${p.paypalUrl?`<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #ddd">
<p style="font-size:0.9rem;color:#666;margin-bottom:0.5rem">${t[lang].directPayment}</p>
<a href="${p.paypalUrl}" class="btn btn-paypal" target="_blank" style="font-size:0.9rem;">üí≥ PayPal.me</a>
</div>`:''}
<div id="single-paypal-container" style="margin-top:1rem;"></div>
</div>
`;
document.getElementById('modal').classList.remove('hidden');
document.getElementById('modal').style.display='flex';
}

function closeModal(){
document.getElementById('modal').classList.add('hidden');
document.getElementById('modal').style.display='none';
}

function showAlert(msg,type){
const c=document.getElementById('alertContainer');
const a=document.createElement('div');
a.className=`alert alert-${type}`;
a.textContent=msg;
c.appendChild(a);
setTimeout(()=>a.remove(),3000);
}

// Inicializaci√≥n
loadProducts();
updateTexts();
updateCurrency();
updateUserInfo();
renderPayPalButton();
initEmailJS();
updateEmailStatus();

document.getElementById('modal').addEventListener('click',e=>{
if(e.target===document.getElementById('modal'))closeModal();
});
</script>
</body>
</html>
