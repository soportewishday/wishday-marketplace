<!DOCTYPE html>
<html>
<head>
<title>MiniTienda</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:var(--bg-color, #f5f5f5)}

/* Variables CSS para personalización */
:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #27ae60;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --bg-color: #f5f5f5;
    --card-bg: #ffffff;
    --text-color: #2c3e50;
    --text-light: #7f8c8d;
    --border-radius: 4px;
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
    --font-family: Arial, sans-serif;
}

.h{background:var(--primary-color);color:white;padding:1rem;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:1.5rem;font-weight:bold;color:white}
.nav{display:flex;gap:0.5rem}
.nav button,.nav select{background:var(--secondary-color);color:white;border:none;padding:0.5rem;border-radius:var(--border-radius);cursor:pointer}
.nav button:hover{background:var(--accent-color)}
.c{max-width:1200px;margin:0 auto;padding:2rem}
.hidden{display:none !important}
.fg{margin-bottom:1rem}
.fg label{display:block;margin-bottom:0.25rem;font-weight:bold;color:var(--text-color)}
.fg input,.fg textarea{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:var(--border-radius);font-family:var(--font-family)}
.fg select{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:var(--border-radius);background:white}
.password-container{position:relative}
.password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--text-light);font-size:1.2rem;user-select:none}
.phone-container{display:flex;gap:0.5rem}
.phone-container select{flex:0 0 120px}
.phone-container input{flex:1}
.btn{background:var(--accent-color);color:white;border:none;padding:0.75rem 1rem;border-radius:var(--border-radius);cursor:pointer;margin:0.5rem 0.5rem 0.5rem 0;font-family:var(--font-family)}
.btn:hover{background:#229954}
.btn-danger{background:var(--danger-color)}
.btn-warning{background:var(--warning-color)}
.btn-paypal{background:#ffc439;color:#003087;text-decoration:none;display:inline-block;text-align:center}
.btn-paypal-cart{background:#0070ba;color:white;font-size:1.1rem;padding:1rem 2rem}
.btn-buy-now{background:#ff6b35;color:white;border:none;padding:0.75rem 1rem;border-radius:var(--border-radius);cursor:pointer;margin:0.5rem 0.5rem 0.5rem 0;text-decoration:none;display:inline-block;text-align:center}
.btn-buy-now:hover{background:#e55a2b}

/* ESTILOS PARA CATEGORÍAS */
.categories-section{margin-bottom:2rem}
.categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem}
.category-card{background:var(--card-bg);border-radius:8px;padding:1rem;text-align:center;cursor:pointer;transition:all 0.3s;box-shadow:var(--shadow);border:2px solid transparent;position:relative}
.category-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}
.category-card.active{border-color:var(--secondary-color);background:#e3f2fd}
.category-card.disabled{cursor:not-allowed;opacity:0.7}
.category-card.disabled:hover{transform:none;box-shadow:var(--shadow)}
.category-icon{font-size:2.5rem;margin-bottom:0.5rem;display:block}
.category-name{font-weight:bold;color:var(--text-color);font-size:0.9rem}
.category-count{font-size:0.8rem;color:var(--text-light);margin-top:0.25rem}
.filter-section{display:flex;gap:1rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap}
.filter-section select{padding:0.5rem;border:1px solid #ddd;border-radius:var(--border-radius);background:white}
.clear-filters{background:var(--danger-color);color:white;padding:0.5rem 1rem;border:none;border-radius:var(--border-radius);cursor:pointer}
.clear-filters:hover{background:#c0392b}
.clear-filters:disabled{opacity:0.6;cursor:not-allowed}
.clear-filters:disabled:hover{background:var(--danger-color)}

.products{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-top:2rem}
.product{background:var(--card-bg);border-radius:8px;padding:1rem;box-shadow:var(--shadow);cursor:pointer;transition:transform 0.2s;position:relative}
.product:hover{transform:scale(1.02)}
.product h3{color:var(--text-color);margin-bottom:0.5rem}
.product p{color:var(--text-light);margin-bottom:1rem}
.price{font-size:1.25rem;font-weight:bold;color:var(--accent-color);margin-bottom:0.5rem}
.shipping-info{font-size:0.9rem;color:#666;margin-bottom:0.5rem;padding:0.5rem;background:#f8f9fa;border-radius:var(--border-radius)}
.shipping-free{color:var(--accent-color);font-weight:bold}
.shipping-paid{color:#e67e22}
.delivery-info{font-size:0.85rem;color:#8e44ad;margin-bottom:1rem;padding:0.4rem;background:#f3e5f5;border-radius:var(--border-radius);border-left:3px solid #8e44ad}
.pb{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem}
.pi{width:100%;height:200px;object-fit:cover;border-radius:var(--border-radius);margin-bottom:1rem;background:#ecf0f1;display:flex;align-items:center;justify-content:center;color:var(--text-light)}
.product-category{position:absolute;top:0.5rem;right:0.5rem;background:var(--secondary-color);color:white;padding:0.25rem 0.5rem;border-radius:12px;font-size:0.7rem;font-weight:bold}

/* EDITOR VISUAL ESTILO WIX - COMPLETAMENTE NUEVO */
.wix-editor-panel{position:fixed;top:0;right:-450px;width:450px;height:100vh;background:var(--card-bg);box-shadow:-2px 0 15px rgba(0,0,0,0.2);z-index:3000;transition:right 0.4s cubic-bezier(0.25,0.8,0.25,1);overflow-y:auto;border-left:2px solid var(--primary-color)}
.wix-editor-panel.open{right:0}

.wix-editor-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:white;padding:1.5rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.wix-editor-header h2{font-size:1.3rem;font-weight:600}
.wix-editor-close{background:none;border:none;color:white;font-size:1.8rem;cursor:pointer;padding:0.5rem;border-radius:50%;transition:background 0.3s}
.wix-editor-close:hover{background:rgba(255,255,255,0.2)}

.wix-editor-content{padding:0}

.wix-editor-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef}
.wix-editor-tab{flex:1;padding:1rem;text-align:center;cursor:pointer;border:none;background:none;color:#6c757d;font-weight:500;transition:all 0.3s}
.wix-editor-tab.active{background:white;color:var(--primary-color);border-bottom:3px solid var(--accent-color)}
.wix-editor-tab:hover{background:#e9ecef}

.wix-tab-content{display:none;padding:1.5rem}
.wix-tab-content.active{display:block}

/* Herramientas de Construcción */
.wix-tools-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:2rem}
.wix-tool-card{background:#f8f9fa;border:2px dashed #dee2e6;border-radius:8px;padding:1rem;text-align:center;cursor:pointer;transition:all 0.3s}
.wix-tool-card:hover{border-color:var(--accent-color);background:#e8f5e8}
.wix-tool-icon{font-size:2rem;margin-bottom:0.5rem;display:block}
.wix-tool-name{font-weight:bold;color:var(--text-color);font-size:0.9rem}

/* Secciones Editables */
.editable-section{position:relative;transition:all 0.3s}
.editable-section:hover{box-shadow:0 0 0 2px var(--accent-color);border-radius:4px}
.section-controls{position:absolute;top:-40px;right:0;background:var(--accent-color);border-radius:6px;padding:0.5rem;opacity:0;transition:opacity 0.3s;z-index:100}
.editable-section:hover .section-controls{opacity:1}
.section-control-btn{background:white;color:var(--accent-color);border:none;padding:0.25rem 0.5rem;margin:0 0.25rem;border-radius:3px;cursor:pointer;font-size:0.8rem}

/* Plantillas de Sección */
.wix-templates-grid{display:grid;gap:1rem}
.wix-template-card{border:1px solid #dee2e6;border-radius:8px;overflow:hidden;cursor:pointer;transition:all 0.3s}
.wix-template-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.wix-template-preview{height:120px;background-size:cover;background-position:center;background-color:#f8f9fa;display:flex;align-items:center;justify-content:center;color:#6c757d}
.wix-template-info{padding:1rem}
.wix-template-name{font-weight:bold;color:var(--text-color);margin-bottom:0.5rem}
.wix-template-desc{font-size:0.85rem;color:var(--text-light)}

/* Editor de Elementos */
.wix-element-editor{background:#f8f9fa;border-radius:8px;padding:1rem;margin-bottom:1rem}
.wix-element-editor h4{color:var(--primary-color);margin-bottom:1rem;font-size:1.1rem}

.wix-property-group{margin-bottom:1.5rem}
.wix-property-group h5{color:var(--text-color);margin-bottom:0.75rem;font-size:0.95rem}

.wix-color-palette{display:grid;grid-template-columns:repeat(8,1fr);gap:0.25rem;margin-bottom:0.5rem}
.wix-color-swatch{width:30px;height:30px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
.wix-color-swatch.active{border-color:var(--primary-color);transform:scale(1.1)}

.wix-slider-container{margin-bottom:1rem}
.wix-slider{width:100%;margin-bottom:0.5rem}
.wix-slider-label{display:flex;justify-content:space-between;font-size:0.85rem;color:var(--text-color)}

/* Modo de Construcción */
.construction-mode .c{max-width:none;padding:0}
.construction-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.1);z-index:2000;pointer-events:none}
.construction-mode .construction-overlay{pointer-events:all}

/* Indicadores de Modo de Edición */
.edit-mode-indicator{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--accent-color);color:white;padding:0.75rem 1.5rem;border-radius:25px;font-weight:bold;z-index:2500;box-shadow:0 4px 12px rgba(0,0,0,0.2)}

/* Toggle Button Mejorado */
.wix-editor-toggle{position:fixed;top:50%;right:20px;z-index:2999;background:linear-gradient(135deg,var(--accent-color),#27ae60);color:white;border:none;padding:1.2rem;border-radius:50%;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3);width:70px;height:70px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;transition:all 0.3s}
.wix-editor-toggle:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,0.4)}

/* Nuevos estilos para secciones dinámicas */
.hero-section{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:white;padding:4rem 0;text-align:center}
.features-section{padding:3rem 0;background:white}
.testimonials-section{background:#f8f9fa;padding:3rem 0}
.cta-section{background:var(--accent-color);color:white;padding:3rem 0;text-align:center}

.feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:2rem;margin-top:2rem}
.feature-item{text-align:center;padding:1.5rem;background:white;border-radius:8px;box-shadow:var(--shadow)}
.feature-icon{font-size:3rem;margin-bottom:1rem;color:var(--accent-color)}

.testimonial-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem;margin-top:2rem}
.testimonial-item{background:white;padding:2rem;border-radius:8px;box-shadow:var(--shadow)}

/* Drag and Drop */
.dragging{opacity:0.5;transform:rotate(5deg)}
.drop-zone{border:2px dashed var(--accent-color);border-radius:8px;padding:2rem;text-align:center;color:var(--accent-color);margin:1rem 0}
.drop-zone.active{background:rgba(39,174,96,0.1);border-color:var(--accent-color)}

/* Resto de estilos originales */
.ci{background:var(--card-bg);padding:1rem;margin-bottom:0.5rem;border-radius:var(--border-radius);display:flex;justify-content:space-between;align-items:center}
.ct{background:#34495e;color:white;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;text-align:right}
.ct .payment-options{display:flex;gap:1rem;justify-content:flex-end;align-items:center;margin-top:1rem;flex-wrap:wrap}
.ap{background:#8e44ad;color:white;padding:2rem;border-radius:8px;margin-top:2rem}
.af{background:#9b59b6;padding:1rem;border-radius:var(--border-radius);margin-top:1rem}
.ui{background:var(--secondary-color);color:white;padding:1rem;border-radius:var(--border-radius);margin-bottom:1rem}
.alert{padding:1rem;margin-bottom:1rem;border-radius:var(--border-radius)}
.alert-success{background:#d4edda;color:#155724}
.alert-error{background:#f8d7da;color:#721c24}
.cart-limit{color:var(--danger-color);font-size:0.9rem;margin-top:0.5rem}
.paypal-config{background:#f8f9fa;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid #0070ba}
.email-config{background:#f8f9fa;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid #e67e22}
.shipping-section{background:#f8f9fa;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid #16a085}
.shipping-option{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem}
.shipping-option input[type="radio"]{margin-right:0.25rem}
.shipping-price-input{margin-left:1.5rem;margin-top:0.5rem}
.delivery-section{background:#f3e5f5;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid #8e44ad}
.delivery-option{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem}
.delivery-days-input{margin-left:1.5rem;margin-top:0.5rem;display:flex;gap:0.5rem;align-items:center}
.delivery-days-input input{width:80px}
.delivery-origin-input{margin-left:1.5rem;margin-top:0.5rem}
.delivery-origin-input input{width:100%}
.thank-you-page{background:var(--card-bg);padding:3rem;border-radius:12px;text-align:center;max-width:600px;margin:0 auto;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.thank-you-page h2{color:var(--accent-color);font-size:2.5rem;margin-bottom:1rem}
.thank-you-page .checkmark{font-size:4rem;color:var(--accent-color);margin-bottom:1rem}
.thank-you-page p{font-size:1.1rem;color:var(--text-color);margin-bottom:1.5rem;line-height:1.6}
.email-highlight{background:#e8f5e8;padding:0.5rem;border-radius:var(--border-radius);font-weight:bold;color:var(--accent-color)}
.activation-section{background:#f8f9fa;padding:2rem;border-radius:8px;margin-top:2rem}
.activation-input{display:flex;gap:0.5rem;margin-top:1rem}
.activation-input input{flex:1;padding:0.75rem;border:1px solid #ddd;border-radius:var(--border-radius);font-size:1rem}
.account-status{padding:1rem;border-radius:var(--border-radius);margin-bottom:1rem;font-weight:bold}
.status-pending{background:#fff3cd;color:#856404}
.status-active{background:#d4edda;color:#155724}
.data-controls{background:var(--primary-color);color:white;padding:1rem;border-radius:var(--border-radius);margin-top:1rem}
.cart-item-shipping{font-size:0.85rem;color:#666;margin-top:0.25rem}
.cart-item-delivery{font-size:0.8rem;color:#8e44ad;margin-top:0.25rem;font-style:italic}
.cart-totals{background:#ecf0f1;padding:1rem;border-radius:var(--border-radius);margin-top:1rem}
.cart-totals .line{display:flex;justify-content:space-between;margin-bottom:0.5rem}
.cart-totals .total-line{font-weight:bold;font-size:1.1rem;border-top:1px solid #bdc3c7;padding-top:0.5rem;margin-top:0.5rem}
#paypal-button-container{margin-top:1rem}
#single-paypal-container{margin-top:1rem}
.delivery-management{background:#f8f9fa;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid #8e44ad}
.delivery-preset{background:var(--card-bg);border:1px solid #ddd;border-radius:var(--border-radius);padding:0.75rem;margin-bottom:0.5rem;display:flex;justify-content:space-between;align-items:center}
.delivery-preset-name{font-weight:bold;color:var(--text-color)}
.delivery-preset-info{font-size:0.85rem;color:#666}
.delivery-preset-actions{display:flex;gap:0.25rem}
.delivery-preset-actions button{padding:0.25rem 0.5rem;font-size:0.8rem;border:none;border-radius:3px;cursor:pointer}
.delivery-preset-edit{background:var(--warning-color);color:white}
.delivery-preset-delete{background:var(--danger-color);color:white}
.source-section{background:#fff3cd;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid var(--warning-color)}
.source-info{font-size:0.85rem;color:#856404;margin-bottom:0.5rem;padding:0.4rem;background:#fff8e1;border-radius:var(--border-radius);border-left:3px solid var(--warning-color);display:flex;align-items:center;gap:0.5rem}
.admin-only-info{background:#e8f5e8;border-left:3px solid var(--accent-color);padding:0.5rem;margin-top:0.5rem;border-radius:var(--border-radius);font-size:0.85rem;color:#155724}
.admin-only-info .icon{font-weight:bold;margin-right:0.5rem}
.category-section{background:#f8f9fa;padding:1rem;border-radius:var(--border-radius);margin-top:1rem;border-left:4px solid #9b59b6}
.category-section h4{color:var(--text-color);margin-bottom:0.5rem}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
.mc{background:var(--card-bg);padding:2rem;width:90%;max-width:600px;border-radius:8px;position:relative}
.cb{position:absolute;top:1rem;right:1.5rem;font-size:2rem;cursor:pointer;color:var(--text-light)}
.image-upload{position:relative;display:inline-block;width:100%}
.image-upload input[type=file]{position:absolute;left:-9999px}
.image-upload label{display:block;padding:0.75rem;background:var(--secondary-color);color:white;border-radius:var(--border-radius);cursor:pointer;text-align:center;transition:background 0.3s}
.image-upload label:hover{background:#2980b9}
.image-preview{width:100%;height:200px;border:2px dashed #ddd;border-radius:var(--border-radius);display:flex;align-items:center;justify-content:center;margin-top:0.5rem;background:#f8f9fa;position:relative;overflow:hidden}
.image-preview img{width:100%;height:100%;object-fit:cover;border-radius:var(--border-radius)}
.image-preview .placeholder{color:var(--text-light);text-align:center}
.remove-image{position:absolute;top:5px;right:5px;background:var(--danger-color);color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:12px}

/* RESPONSIVE */
@media (max-width: 768px) {
    .categories-grid{grid-template-columns:repeat(3,1fr);gap:0.5rem}
    .category-card{padding:0.75rem}
    .category-icon{font-size:2rem}
    .category-name{font-size:0.8rem}
    .filter-section{flex-direction:column;align-items:stretch;gap:0.5rem}
    .wix-editor-panel{width:100%;right:-100%}
    .wix-editor-toggle{right:10px}
    .wix-tools-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<!-- Editor Toggle Button - Solo para Admin -->
<button class="wix-editor-toggle" id="wixEditorToggle" onclick="toggleWixEditor()" title="Abrir Editor Wix" style="display:none;">🎨</button>

<!-- Indicador de Modo Edición -->
<div class="edit-mode-indicator hidden" id="editModeIndicator">✏️ Modo Edición Activo</div>

<!-- Overlay de Construcción -->
<div class="construction-overlay hidden" id="constructionOverlay"></div>

<!-- Editor Panel Estilo Wix -->
<div class="wix-editor-panel" id="wixEditorPanel">
    <div class="wix-editor-header">
        <h2>🎨 Constructor Visual</h2>
        <button class="wix-editor-close" onclick="toggleWixEditor()">×</button>
    </div>
    
    <!-- Tabs del Editor -->
    <div class="wix-editor-tabs">
        <button class="wix-editor-tab active" onclick="showWixTab('design')">🎨 Diseño</button>
        <button class="wix-editor-tab" onclick="showWixTab('sections')">📋 Secciones</button>
        <button class="wix-editor-tab" onclick="showWixTab('elements')">🧩 Elementos</button>
        <button class="wix-editor-tab" onclick="showWixTab('templates')">🎯 Plantillas</button>
    </div>
    
    <!-- Contenido del Tab de Diseño -->
    <div class="wix-tab-content active" id="wix-design-tab">
        <!-- Colores Globales -->
        <div class="wix-element-editor">
            <h4>🎨 Paleta de Colores</h4>
            <div class="wix-property-group">
                <h5>Color Principal</h5>
                <div class="wix-color-palette" id="primaryColorPalette"></div>
                <input type="color" id="customPrimaryColor" onchange="updateCustomColor('--primary-color', this.value)">
            </div>
            
            <div class="wix-property-group">
                <h5>Color Secundario</h5>
                <div class="wix-color-palette" id="secondaryColorPalette"></div>
                <input type="color" id="customSecondaryColor" onchange="updateCustomColor('--secondary-color', this.value)">
            </div>
            
            <div class="wix-property-group">
                <h5>Color de Acento</h5>
                <div class="wix-color-palette" id="accentColorPalette"></div>
                <input type="color" id="customAccentColor" onchange="updateCustomColor('--accent-color', this.value)">
            </div>
        </div>
        
        <!-- Tipografía -->
        <div class="wix-element-editor">
            <h4>📝 Tipografía</h4>
            <div class="wix-property-group">
                <label>Fuente Principal</label>
                <select id="wixFontSelect" onchange="updateGlobalFont(this.value)">
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                    <option value="'Georgia', serif">Georgia</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                    <option value="'Verdana', sans-serif">Verdana</option>
                    <option value="'Poppins', sans-serif">Poppins (Google Fonts)</option>
                    <option value="'Roboto', sans-serif">Roboto (Google Fonts)</option>
                    <option value="'Inter', sans-serif">Inter (Google Fonts)</option>
                </select>
            </div>
            
            <div class="wix-property-group">
                <label>Tamaño Base</label>
                <div class="wix-slider-container">
                    <input type="range" class="wix-slider" min="12" max="24" value="16" id="baseFontSize" onchange="updateBaseFontSize(this.value)">
                    <div class="wix-slider-label">
                        <span>12px</span>
                        <span id="currentBaseFontSize">16px</span>
                        <span>24px</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Espaciado -->
        <div class="wix-element-editor">
            <h4>📐 Espaciado y Bordes</h4>
            <div class="wix-property-group">
                <label>Radio de Bordes</label>
                <div class="wix-slider-container">
                    <input type="range" class="wix-slider" min="0" max="25" value="4" id="borderRadiusSlider" onchange="updateBorderRadius(this.value + 'px')">
                    <div class="wix-slider-label">
                        <span>0px</span>
                        <span id="currentBorderRadius">4px</span>
                        <span>25px</span>
                    </div>
                </div>
            </div>
            
            <div class="wix-property-group">
                <label>Intensidad de Sombras</label>
                <select id="shadowIntensity" onchange="updateShadowIntensity(this.value)">
                    <option value="none">Sin sombra</option>
                    <option value="light" selected>Ligera</option>
                    <option value="medium">Media</option>
                    <option value="strong">Fuerte</option>
                </select>
            </div>
        </div>
        
        <!-- Temas Predefinidos -->
        <div class="wix-element-editor">
            <h4>🎨 Temas Rápidos</h4>
            <div class="wix-tools-grid">
                <div class="wix-tool-card" onclick="applyWixTheme('modern')">
                    <span class="wix-tool-icon">🌊</span>
                    <div class="wix-tool-name">Moderno</div>
                </div>
                <div class="wix-tool-card" onclick="applyWixTheme('dark')">
                    <span class="wix-tool-icon">🌙</span>
                    <div class="wix-tool-name">Oscuro</div>
                </div>
                <div class="wix-tool-card" onclick="applyWixTheme('nature')">
                    <span class="wix-tool-icon">🌿</span>
                    <div class="wix-tool-name">Natural</div>
                </div>
                <div class="wix-tool-card" onclick="applyWixTheme('elegant')">
                    <span class="wix-tool-icon">✨</span>
                    <div class="wix-tool-name">Elegante</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contenido del Tab de Secciones -->
    <div class="wix-tab-content" id="wix-sections-tab">
        <div class="wix-element-editor">
            <h4>➕ Agregar Secciones</h4>
            <div class="wix-tools-grid">
                <div class="wix-tool-card" onclick="addWixSection('hero')">
                    <span class="wix-tool-icon">🏆</span>
                    <div class="wix-tool-name">Hero Banner</div>
                </div>
                <div class="wix-tool-card" onclick="addWixSection('features')">
                    <span class="wix-tool-icon">⚡</span>
                    <div class="wix-tool-name">Características</div>
                </div>
                <div class="wix-tool-card" onclick="addWixSection('testimonials')">
                    <span class="wix-tool-icon">💬</span>
                    <div class="wix-tool-name">Testimonios</div>
                </div>
                <div class="wix-tool-card" onclick="addWixSection('cta')">
                    <span class="wix-tool-icon">📢</span>
                    <div class="wix-tool-name">Llamada a Acción</div>
                </div>
                <div class="wix-tool-card" onclick="addWixSection('gallery')">
                    <span class="wix-tool-icon">🖼️</span>
                    <div class="wix-tool-name">Galería</div>
                </div>
                <div class="wix-tool-card" onclick="addWixSection('contact')">
                    <span class="wix-tool-icon">📞</span>
                    <div class="wix-tool-name">Contacto</div>
                </div>
            </div>
        </div>
        
        <!-- Control de Secciones Existentes -->
        <div class="wix-element-editor">
            <h4>📋 Secciones Actuales</h4>
            <div id="currentSectionsList">
                <!-- Se llenarán dinámicamente -->
            </div>
        </div>
    </div>
    
    <!-- Contenido del Tab de Elementos -->
    <div class="wix-tab-content" id="wix-elements-tab">
        <div class="wix-element-editor">
            <h4>🧩 Elementos Básicos</h4>
            <div class="wix-tools-grid">
                <div class="wix-tool-card" onclick="addWixElement('text')">
                    <span class="wix-tool-icon">📝</span>
                    <div class="wix-tool-name">Texto</div>
                </div>
                <div class="wix-tool-card" onclick="addWixElement('image')">
                    <span class="wix-tool-icon">🖼️</span>
                    <div class="wix-tool-name">Imagen</div>
                </div>
                <div class="wix-tool-card" onclick="addWixElement('button')">
                    <span class="wix-tool-icon">🔲</span>
                    <div class="wix-tool-name">Botón</div>
                </div>
                <div class="wix-tool-card" onclick="addWixElement('divider')">
                    <span class="wix-tool-icon">➖</span>
                    <div class="wix-tool-name">Divisor</div>
                </div>
                <div class="wix-tool-card" onclick="addWixElement('spacer')">
                    <span class="wix-tool-icon">⬜</span>
                    <div class="wix-tool-name">Espaciador</div>
                </div>
                <div class="wix-tool-card" onclick="addWixElement('video')">
                    <span class="wix-tool-icon">🎥</span>
                    <div class="wix-tool-name">Video</div>
                </div>
            </div>
        </div>
        
        <!-- Editor de Elemento Seleccionado -->
        <div class="wix-element-editor" id="selectedElementEditor" style="display:none;">
            <h4>✏️ Editar Elemento</h4>
            <div id="elementProperties">
                <!-- Se llenarán dinámicamente según el elemento seleccionado -->
            </div>
        </div>
    </div>
    
    <!-- Contenido del Tab de Plantillas -->
    <div class="wix-tab-content" id="wix-templates-tab">
        <div class="wix-element-editor">
            <h4>🎯 Plantillas de Página</h4>
            <div class="wix-templates-grid">
                <div class="wix-template-card" onclick="applyPageTemplate('ecommerce')">
                    <div class="wix-template-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <span style="color:white;font-weight:bold;">🛒</span>
                    </div>
                    <div class="wix-template-info">
                        <div class="wix-template-name">E-commerce Clásico</div>
                        <div class="wix-template-desc">Diseño perfecto para tiendas online con hero, productos y testimonios</div>
                    </div>
                </div>
                
                <div class="wix-template-card" onclick="applyPageTemplate('minimal')">
                    <div class="wix-template-preview" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <span style="color:white;font-weight:bold;">✨</span>
                    </div>
                    <div class="wix-template-info">
                        <div class="wix-template-name">Minimalista</div>
                        <div class="wix-template-desc">Diseño limpio y moderno con enfoque en el contenido</div>
                    </div>
                </div>
                
                <div class="wix-template-card" onclick="applyPageTemplate('corporate')">
                    <div class="wix-template-preview" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <span style="color:white;font-weight:bold;">🏢</span>
                    </div>
                    <div class="wix-template-info">
                        <div class="wix-template-name">Corporativo</div>
                        <div class="wix-template-desc">Diseño profesional para empresas y servicios</div>
                    </div>
                </div>
                
                <div class="wix-template-card" onclick="applyPageTemplate('creative')">
                    <div class="wix-template-preview" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <span style="color:white;font-weight:bold;">🎨</span>
                    </div>
                    <div class="wix-template-info">
                        <div class="wix-template-name">Creativo</div>
                        <div class="wix-template-desc">Diseño vibrante y moderno para portfolios y creativos</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controles de Plantilla -->
        <div class="wix-element-editor">
            <h4>💾 Gestión de Diseño</h4>
            <button class="btn" onclick="saveWixDesign()" style="width:100%;margin-bottom:0.5rem;">💾 Guardar Diseño</button>
            <button class="btn" onclick="loadWixDesign()" style="width:100%;margin-bottom:0.5rem;background:#9b59b6;">📥 Cargar Diseño</button>
            <button class="btn btn-danger" onclick="resetWixDesign()" style="width:100%;">🔄 Restablecer Todo</button>
            <input type="file" id="wixDesignFile" accept=".json" style="display:none;" onchange="handleWixDesignImport(this)">
        </div>
    </div>
</div>

<!-- RESTO DEL HTML ORIGINAL -->
<div class="h">
<div class="logo">🛒 <span id="sn">MiniTienda</span></div>
<div class="nav">
<button onclick="showSection('tienda')" id="sb">Tienda</button>
<button onclick="showSection('carrito')"><span id="cb">Carrito</span> (<span id="cc">0</span>)</button>
<button id="lb" onclick="showSection('login')">Login</button>
<button id="ob" onclick="logout()" class="hidden">Logout</button>
<button id="ab" onclick="showSection('admin')" class="hidden">Admin</button>
<select id="ls" onchange="changeLang()">
<option value="es">🇪🇸</option>
<option value="en">🇺🇸</option>
</select>
<select id="cs" onchange="changeCurr()">
<option value="USD">$</option>
<option value="CRC">₡</option>
</select>
</div>
</div>

<!-- Contenedor Principal con ID para poder editarlo -->
<div class="c" id="mainContent">
<div id="alertContainer"></div>
<div id="userInfo" class="ui hidden">
<span id="wt"></span>
<div id="account-status" class="account-status hidden">
<span id="status-text"></span>
</div>
</div>

<!-- Contenedor de Secciones Dinámicas -->
<div id="dynamicSections"></div>

<div id="tienda">
<h2 id="pt">Productos Disponibles</h2>

<!-- SECCIÓN DE CATEGORÍAS PROTEGIDA -->
<div class="categories-section" id="categories-section-container">
<h3 id="categories-title">Categorías</h3>
<div class="categories-grid" id="categories-grid">
<!-- Las categorías se cargarán aquí -->
</div>
</div>

<!-- SECCIÓN DE FILTROS -->
<div class="filter-section">
<span id="filter-label">Filtrar por:</span>
<select id="category-filter" onchange="filterByCategory()">
<option value="">Todas las categorías</option>
</select>
<button class="clear-filters" onclick="clearAllFilters()" id="clear-filters">Limpiar filtros</button>
</div>

<div class="products" id="pg"></div>
</div>

<!-- Drop Zone para nuevas secciones -->
<div class="drop-zone hidden" id="mainDropZone">
    <div>📋 Arrastra aquí para agregar una nueva sección</div>
</div>

<!-- RESTO DE LAS SECCIONES ORIGINALES -->
<div id="carrito" class="hidden">
<h2 id="ct2">Mi Carrito</h2>
<div id="ci2"></div>
<div class="ct">
<div class="cart-totals">
<div class="line">
<span id="subtotal-label">Subtotal:</span>
<span><span id="sy2">$</span><span id="subtotal-amount">0</span></span>
</div>
<div class="line">
<span id="shipping-label">Envío:</span>
<span><span id="sy4">$</span><span id="shipping-amount">0</span></span>
</div>
<div class="line total-line">
<span id="tt">Total:</span>
<span><span id="sy5">$</span><span id="tp">0</span></span>
</div>
</div>
<div class="cart-limit">
<span id="cl">Máximo 15 productos en el carrito</span> - <span id="current-items">0</span>/15
</div>
<div class="payment-options">
<button class="btn btn-paypal-cart" onclick="triggerPayPalCheckout()" id="buy-now-btn">🛒 Comprar Ahora</button>
<div id="paypal-button-container"></div>
</div>
</div>
</div>

<div id="login" class="hidden">
<h2 id="lt">Login</h2>
<div class="fg">
<label>Email:</label>
<input type="email" id="le" placeholder="email@email.com">
</div>
<div class="fg">
<label id="pl">Password:</label>
<div class="password-container">
<input type="password" id="lp">
<span class="password-toggle" onclick="togglePassword('lp', this)">👁️</span>
</div>
</div>
<button class="btn" onclick="login()" id="lab">Login</button>
<button class="btn" onclick="showSection('registro')" id="cb3">Crear</button>
</div>

<div id="registro" class="hidden">
<h2 id="rt">Registro</h2>
<div class="fg">
<label id="nl">Nombre:</label>
<input type="text" id="rn">
</div>
<div class="fg">
<label>Email:</label>
<input type="email" id="re">
</div>
<div class="fg">
<label id="phone-label">Teléfono:</label>
<div class="phone-container">
<select id="country-code">
<option value="+506" selected>🇨🇷 +506</option>
<option value="+34">🇪🇸 +34</option>
<option value="+507">🇵🇦 +507</option>
<option value="+505">🇳🇮 +505</option>
</select>
<input type="tel" id="rph" placeholder="8888-8888" required>
</div>
</div>
<div class="fg">
<label id="cedula-label">Cédula/ID:</label>
<input type="text" id="cedula" placeholder="1-1234-5678" required>
</div>
<div class="fg">
<label id="address-label">Dirección de Envío:</label>
<textarea id="address" placeholder="Dirección completa para envíos..." rows="3" required></textarea>
</div>
<div class="fg">
<label id="pl2">Password:</label>
<div class="password-container">
<input type="password" id="rp" required>
<span class="password-toggle" onclick="togglePassword('rp', this)">👁️</span>
</div>
</div>
<button class="btn" onclick="register()" id="rb">Crear</button>
</div>

<div id="thank-you" class="hidden">
<div class="thank-you-page">
<div class="checkmark">✅</div>
<h2 id="ty-title">¡Gracias por Registrarte!</h2>
<p id="ty-message">
Hemos enviado un email de confirmación a:<br>
<span class="email-highlight" id="ty-email">email@ejemplo.com</span>
</p>
<p id="ty-instructions">
📧 <strong>Por favor revisa tu bandeja de entrada</strong> (y carpeta de spam) y haz clic en el enlace de confirmación para activar tu cuenta.
</p>
<p id="ty-note">
Una vez confirmada tu cuenta, podrás iniciar sesión y realizar compras. 🛒
</p>
<div class="activation-section">
<h3 id="ty-activate-title">¿Ya tienes tu código de activación?</h3>
<p id="ty-activate-desc">Ingresa el código que recibiste por email:</p>
<div class="activation-input">
<input type="text" id="activation-code" placeholder="Código de activación">
<button class="btn" onclick="activateAccount()">Activar</button>
</div>
</div>
<button class="btn" onclick="showSection('login')" style="margin-top:2rem;">Volver al Login</button>
</div>
</div>

<div id="admin" class="hidden ap">
<h2 id="at">Admin Panel</h2>

<div class="af paypal-config">
<h3>💳 Configuración PayPal</h3>
<div class="fg">
<label>Client ID:</label>
<input type="text" id="paypal-client-id" placeholder="Tu PayPal Client ID" value="ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn">
</div>
<div class="fg">
<label>Modo:</label>
<select id="paypal-mode">
<option value="live">Live (Producción)</option>
<option value="sandbox">Sandbox (Pruebas)</option>
</select>
</div>
<button class="btn" onclick="savePayPalConfig()">💾 Guardar Configuración</button>
</div>

<div class="af email-config">
<h3>📧 Configuración de Email</h3>
<div class="fg">
<label>Tu Email (donde recibirás las notificaciones):</label>
<input type="email" id="admin-email" placeholder="admin@mitienda.com" value="admin@mitienda.com">
</div>
<div class="fg">
<label>Servicio de Email:</label>
<select id="email-service">
<option value="emailjs">EmailJS (Recomendado - Gratis)</option>
<option value="formspree">Formspree (Alternativa)</option>
<option value="webhook">Webhook Personalizado</option>
</select>
</div>
<div class="fg">
<label>EmailJS Service ID:</label>
<input type="text" id="emailjs-service" placeholder="service_xxxxxxx">
</div>
<div class="fg">
<label>EmailJS Template ID (Ventas):</label>
<input type="text" id="emailjs-template" placeholder="template_xxxxxxx">
</div>
<div class="fg">
<label>EmailJS Template ID (Confirmación):</label>
<input type="text" id="emailjs-template-confirm" placeholder="template_xxxxxxx">
</div>
<div class="fg">
<label>EmailJS Public Key:</label>
<input type="text" id="emailjs-public-key" placeholder="xxxxxxxxxxxxxxxxx">
</div>
<button class="btn" onclick="saveEmailConfig()">💾 Guardar Email Config</button>
<button class="btn" onclick="testEmail()" style="background:#e67e22;">🧪 Probar Email</button>
<button class="btn" onclick="testConfirmationEmail()" style="background:#9b59b6;">📧 Probar Confirmación</button>
</div>

<div class="af delivery-management">
<h3>🚚 Gestión de Tiempos de Entrega</h3>
<p style="margin-bottom:1rem;color:#666;">Define diferentes tiempos de entrega para tus productos de dropshipping según su origen.</p>

<div class="fg">
<label>Nombre del Preset:</label>
<input type="text" id="delivery-preset-name" placeholder="ej. China Estándar">
</div>
<div class="fg">
<label>Días Mínimos:</label>
<input type="number" id="delivery-min-days" min="1" placeholder="7">
</div>
<div class="fg">
<label>Días Máximos:</label>
<input type="number" id="delivery-max-days" min="1" placeholder="15">
</div>
<div class="fg">
<label>País/Región de Origen:</label>
<input type="text" id="delivery-origin" placeholder="China, USA, Europa, etc.">
</div>
<button class="btn" onclick="addDeliveryPreset()">➕ Agregar Preset</button>

<div id="delivery-presets-list" style="margin-top:1rem;">
<!-- Los presets se cargarán aquí -->
</div>
</div>

<div class="af">
<h3 id="apt">Agregar Producto</h3>
<div class="fg">
<label>Nombre:</label>
<input type="text" id="apn">
</div>
<div class="fg">
<label>Descripción:</label>
<input type="text" id="apd">
</div>
<div class="fg">
<label>Precio USD:</label>
<input type="number" id="app" step="0.01">
</div>

<!-- NUEVA SECCIÓN DE CATEGORÍA -->
<div class="category-section">
<h4>📂 Categoría del Producto</h4>
<div class="fg">
<label>Seleccionar Categoría:</label>
<select id="product-category" required>
<option value="">Seleccionar categoría...</option>
<option value="hogar">🏠 Hogar</option>
<option value="autos">🚗 Autos</option>
<option value="mascotas">🐾 Mascotas</option>
<option value="jardineria">🌱 Jardinería y Plantas</option>
<option value="electronica">📱 Electrónica y Accesorios</option>
<option value="ropa">👗 Ropa y Accesorios</option>
</select>
</div>
</div>

<div class="source-section">
<h4>🔗 Fuente del Producto (Solo Visible para Admin)</h4>
<p style="margin-bottom:0.5rem;color:#856404;font-size:0.9rem;">Esta información solo será visible para ti como administrador. Los clientes no la verán.</p>
<div class="fg">
<label>Plataforma de Origen:</label>
<select id="product-source-platform">
<option value="">Seleccionar plataforma...</option>
<option value="aliexpress">AliExpress</option>
<option value="amazon">Amazon</option>
<option value="alibaba">Alibaba</option>
<option value="dhgate">DHGate</option>
<option value="banggood">Banggood</option>
<option value="gearbest">Gearbest</option>
<option value="wish">Wish</option>
<option value="ebay">eBay</option>
<option value="taobao">Taobao</option>
<option value="1688">1688.com</option>
<option value="other">Otra</option>
</select>
</div>
<div class="fg">
<label>URL del Producto Original:</label>
<input type="url" id="product-source-url" placeholder="https://es.aliexpress.com/item/...">
</div>
<div class="fg">
<label>Precio de Costo:</label>
<input type="number" id="product-cost-price" step="0.01" placeholder="Precio al que lo compras">
</div>
<div class="fg">
<label>Notas Privadas:</label>
<textarea id="product-private-notes" placeholder="Notas internas sobre este producto, variaciones, proveedores alternativos, etc." rows="3"></textarea>
</div>
</div>

<div class="shipping-section">
<h4>📦 Configuración de Envío</h4>
<div class="shipping-option">
<input type="radio" id="shipping-free" name="shipping-type" value="free" checked onchange="toggleShippingPrice()">
<label for="shipping-free">🆓 Envío Gratis</label>
</div>
<div class="shipping-option">
<input type="radio" id="shipping-paid" name="shipping-type" value="paid" onchange="toggleShippingPrice()">
<label for="shipping-paid">💰 Envío con Costo</label>
</div>
<div class="shipping-price-input hidden" id="shipping-price-container">
<label>Precio de Envío (USD):</label>
<input type="number" id="shipping-price" step="0.01" placeholder="0.00">
</div>
</div>

<div class="delivery-section">
<h4>🚚 Tiempo de Entrega</h4>
<div class="delivery-option">
<input type="radio" id="delivery-preset-option" name="delivery-type" value="preset" checked onchange="toggleDeliveryType()">
<label for="delivery-preset-option">📋 Usar Preset Existente</label>
</div>
<div class="delivery-option">
<input type="radio" id="delivery-custom-option" name="delivery-type" value="custom" onchange="toggleDeliveryType()">
<label for="delivery-custom-option">🎯 Personalizado para este producto</label>
</div>

<div id="delivery-preset-selector" class="delivery-preset-selector">
<label>Seleccionar Preset:</label>
<select id="product-delivery-preset">
<option value="">Seleccionar...</option>
</select>
</div>

<div id="delivery-custom-inputs" class="hidden">
<div class="delivery-days-input">
<label>Días de entrega:</label>
<input type="number" id="custom-delivery-min" min="1" placeholder="Min">
<span>a</span>
<input type="number" id="custom-delivery-max" min="1" placeholder="Max">
<span>días hábiles</span>
</div>
<div class="delivery-origin-input">
<label>Origen del producto:</label>
<input type="text" id="custom-delivery-origin" placeholder="País/Región de origen">
</div>
</div>
</div>

<div class="fg">
<label>Imagen del Producto:</label>
<div class="image-upload">
<input type="file" id="product-image" accept="image/*" onchange="previewImage(this, 'image-preview')">
<label for="product-image">📷 Seleccionar Imagen</label>
</div>
<div class="image-preview" id="image-preview">
<div class="placeholder">📦 Vista previa de la imagen</div>
</div>
</div>
<div class="fg">
<label>Imagen URL (opcional):</label>
<input type="url" id="api" placeholder="https://ejemplo.com/imagen.jpg">
</div>
<div class="fg">
<label>PayPal Individual (opcional):</label>
<input type="url" id="apy" placeholder="https://paypal.me/usuario/precio">
</div>
<button class="btn" onclick="addProduct()" id="apb">Agregar</button>
</div>

<div class="af">
<h3>📊 Estadísticas</h3>
<p>Productos: <span id="tps">0</span></p>
<p>Usuarios: <span id="tus">0</span></p>
<p>Usuarios Activos: <span id="tus-active">0</span></p>
<p>Ventas: <span id="sy3">$</span><span id="ts">0</span></p>
<p>PayPal: <span id="paypal-status">✅ Configurado</span></p>
<p>Email: <span id="email-status">❌ No configurado</span></p>
<p>Presets de Entrega: <span id="delivery-presets-count">0</span></p>
<p>Categorías: <span id="categories-count">6</span></p>
</div>

<div class="af data-controls">
<h3>💾 Control de Datos</h3>
<p style="margin-bottom:1rem;">Los datos se guardan automáticamente en tu navegador</p>
<button class="btn" onclick="exportData()" style="background:#3498db;">📥 Exportar Datos</button>
<button class="btn" onclick="importData()" style="background:#9b59b6;">📤 Importar Datos</button>
<button class="btn btn-danger" onclick="clearAllData()">🗑️ Limpiar Todo</button>
<input type="file" id="import-file" accept=".json" style="display:none;" onchange="handleImport(this)">
</div>
</div>

<div id="modal" class="modal hidden">
<div class="mc">
<span class="cb" onclick="closeModal()">&times;</span>
<div id="mc2"></div>
</div>
</div>
</div>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn&currency=USD"></script>

<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<script>
let lang='es',curr='USD',rate=510;
let users=[{id:1,name:"Admin",email:"admin@tienda.com",password:"admin123",role:"admin",phone:"+506-8888-8888",cedula:"Admin",address:"Admin Address",isActive:true,activationCode:""}];

// SISTEMA DE CATEGORÍAS
const categories = {
    hogar: { id: 'hogar', name: { es: '🏠 Hogar', en: '🏠 Home' }, icon: '🏠' },
    autos: { id: 'autos', name: { es: '🚗 Autos', en: '🚗 Cars' }, icon: '🚗' },
    mascotas: { id: 'mascotas', name: { es: '🐾 Mascotas', en: '🐾 Pets' }, icon: '🐾' },
    jardineria: { id: 'jardineria', name: { es: '🌱 Jardinería y Plantas', en: '🌱 Gardening & Plants' }, icon: '🌱' },
    electronica: { id: 'electronica', name: { es: '📱 Electrónica y Accesorios', en: '📱 Electronics & Accessories' }, icon: '📱' },
    ropa: { id: 'ropa', name: { es: '👗 Ropa y Accesorios', en: '👗 Clothing & Accessories' }, icon: '👗' }
};

let selectedCategory = '';

// SISTEMA DE EDITOR VISUAL WIX
let wixCustomStyles = {};
let wixEditMode = false;
let selectedWixElement = null;
let wixSectionCounter = 0;

// SISTEMA WIX - FUNCIONES PRINCIPALES
function toggleWixEditor() {
    if (!user || user.role !== 'admin') {
        showAlert('Solo los administradores pueden acceder al editor visual', 'error');
        return;
    }
    
    const panel = document.getElementById('wixEditorPanel');
    const indicator = document.getElementById('editModeIndicator');
    const overlay = document.getElementById('constructionOverlay');
    
    panel.classList.toggle('open');
    wixEditMode = panel.classList.contains('open');
    
    if (wixEditMode) {
        indicator.classList.remove('hidden');
        overlay.classList.remove('hidden');
        document.body.classList.add('construction-mode');
        initializeWixColorPalettes();
        updateCurrentSectionsList();
        
        // Actualizar categorías para mostrar controles de admin
        loadCategories();
        updateFilterSection();
    } else {
        indicator.classList.add('hidden');
        overlay.classList.add('hidden');
        document.body.classList.remove('construction-mode');
        
        // Restaurar categorías a modo normal
        loadCategories();
        updateFilterSection();
    }
}

function updateFilterSection() {
    const categoryFilter = document.getElementById('category-filter');
    const clearButton = document.getElementById('clear-filters');
    
    if (wixEditMode && user?.role !== 'admin') {
        categoryFilter.disabled = true;
        categoryFilter.style.opacity = '0.6';
        categoryFilter.style.cursor = 'not-allowed';
        
        clearButton.disabled = true;
        clearButton.style.opacity = '0.6';
        clearButton.style.cursor = 'not-allowed';
    } else {
        categoryFilter.disabled = false;
        categoryFilter.style.opacity = '1';
        categoryFilter.style.cursor = 'pointer';
        
        clearButton.disabled = false;
        clearButton.style.opacity = '1';
        clearButton.style.cursor = 'pointer';
    }
}

function showWixTab(tabName) {
    // Ocultar todas las pestañas
    document.querySelectorAll('.wix-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.wix-editor-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar la pestaña seleccionada
    document.getElementById(`wix-${tabName}-tab`).classList.add('active');
    document.querySelector(`[onclick="showWixTab('${tabName}')"]`).classList.add('active');
}

// SISTEMA DE COLORES WIX
function initializeWixColorPalettes() {
    const colorPalettes = {
        primaryColorPalette: ['#2c3e50', '#34495e', '#1abc9c', '#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#27ae60'],
        secondaryColorPalette: ['#3498db', '#2980b9', '#5dade2', '#85c1e9', '#aed6f1', '#d6eaf8', '#ebf3fd', '#1b4f72'],
        accentColorPalette: ['#27ae60', '#229954', '#58d68d', '#82e0aa', '#a9dfbf', '#d5f4e6', '#eafaf1', '#145a32']
    };
    
    Object.entries(colorPalettes).forEach(([paletteId, colors]) => {
        const palette = document.getElementById(paletteId);
        if (palette) {
            palette.innerHTML = colors.map(color => 
                `<div class="wix-color-swatch" style="background:${color}" onclick="selectWixColor('${paletteId}', '${color}')" title="${color}"></div>`
            ).join('');
        }
    });
}

function selectWixColor(paletteId, color) {
    const palette = document.getElementById(paletteId);
    palette.querySelectorAll('.wix-color-swatch').forEach(swatch => {
        swatch.classList.remove('active');
    });
    palette.querySelector(`[style*="${color}"]`).classList.add('active');
    
    // Aplicar color según la paleta
    if (paletteId === 'primaryColorPalette') {
        updateCustomColor('--primary-color', color);
        document.getElementById('customPrimaryColor').value = color;
    } else if (paletteId === 'secondaryColorPalette') {
        updateCustomColor('--secondary-color', color);
        document.getElementById('customSecondaryColor').value = color;
    } else if (paletteId === 'accentColorPalette') {
        updateCustomColor('--accent-color', color);
        document.getElementById('customAccentColor').value = color;
    }
}

function updateCustomColor(property, value) {
    document.documentElement.style.setProperty(property, value);
    wixCustomStyles[property] = value;
    saveWixDesignToStorage();
}

function updateGlobalFont(fontFamily) {
    document.documentElement.style.setProperty('--font-family', fontFamily);
    wixCustomStyles['--font-family'] = fontFamily;
    saveWixDesignToStorage();
}

function updateBaseFontSize(size) {
    document.documentElement.style.fontSize = size + 'px';
    document.getElementById('currentBaseFontSize').textContent = size + 'px';
    wixCustomStyles['base-font-size'] = size + 'px';
    saveWixDesignToStorage();
}

function updateBorderRadius(radius) {
    document.documentElement.style.setProperty('--border-radius', radius);
    document.getElementById('currentBorderRadius').textContent = radius;
    wixCustomStyles['--border-radius'] = radius;
    saveWixDesignToStorage();
}

function updateShadowIntensity(intensity) {
    const shadows = {
        none: 'none',
        light: '0 2px 4px rgba(0,0,0,0.1)',
        medium: '0 4px 8px rgba(0,0,0,0.15)',
        strong: '0 8px 16px rgba(0,0,0,0.25)'
    };
    
    document.documentElement.style.setProperty('--shadow', shadows[intensity]);
    wixCustomStyles['--shadow'] = shadows[intensity];
    saveWixDesignToStorage();
}

// SISTEMA DE TEMAS WIX
function applyWixTheme(themeName) {
    const themes = {
        modern: {
            '--primary-color': '#1a202c',
            '--secondary-color': '#2d3748',
            '--accent-color': '#4299e1',
            '--bg-color': '#f7fafc',
            '--card-bg': '#ffffff',
            '--text-color': '#2d3748'
        },
        dark: {
            '--primary-color': '#1a1a1a',
            '--secondary-color': '#2d2d2d',
            '--accent-color': '#bb86fc',
            '--bg-color': '#121212',
            '--card-bg': '#1e1e1e',
            '--text-color': '#ffffff'
        },
        nature: {
            '--primary-color': '#2f855a',
            '--secondary-color': '#48bb78',
            '--accent-color': '#68d391',
            '--bg-color': '#f0fff4',
            '--card-bg': '#ffffff',
            '--text-color': '#22543d'
        },
        elegant: {
            '--primary-color': '#553c9a',
            '--secondary-color': '#7c3aed',
            '--accent-color': '#a78bfa',
            '--bg-color': '#faf5ff',
            '--card-bg': '#ffffff',
            '--text-color': '#44337a'
        }
    };
    
    if (themes[themeName]) {
        Object.entries(themes[themeName]).forEach(([property, value]) => {
            document.documentElement.style.setProperty(property, value);
            wixCustomStyles[property] = value;
        });
        
        updateWixColorInputs();
        saveWixDesignToStorage();
        showAlert(`Tema ${themeName} aplicado correctamente`, 'success');
    }
}

function updateWixColorInputs() {
    document.getElementById('customPrimaryColor').value = wixCustomStyles['--primary-color'] || '#2c3e50';
    document.getElementById('customSecondaryColor').value = wixCustomStyles['--secondary-color'] || '#3498db';
    document.getElementById('customAccentColor').value = wixCustomStyles['--accent-color'] || '#27ae60';
}

// SISTEMA DE SECCIONES WIX
function addWixSection(sectionType) {
    wixSectionCounter++;
    const sectionId = `wix-section-${sectionType}-${wixSectionCounter}`;
    
    const sectionTemplates = {
        hero: `
            <div class="hero-section editable-section" id="${sectionId}" data-section="hero">
                <div class="section-controls">
                    <button class="section-control-btn" onclick="editWixSection(this)">✏️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'up')">⬆️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'down')">⬇️</button>
                    <button class="section-control-btn" onclick="deleteWixSection(this)">🗑️</button>
                </div>
                <div class="c">
                    <h1 style="font-size:3rem;margin-bottom:1rem;text-align:center;">Bienvenido a Nuestra Tienda</h1>
                    <p style="font-size:1.2rem;margin-bottom:2rem;text-align:center;opacity:0.9;">Descubre productos increíbles con la mejor calidad</p>
                    <div style="text-align:center;">
                        <button class="btn" style="font-size:1.1rem;padding:1rem 2rem;">Explorar Productos</button>
                    </div>
                </div>
            </div>
        `,
        features: `
            <div class="features-section editable-section" id="${sectionId}" data-section="features">
                <div class="section-controls">
                    <button class="section-control-btn" onclick="editWixSection(this)">✏️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'up')">⬆️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'down')">⬇️</button>
                    <button class="section-control-btn" onclick="deleteWixSection(this)">🗑️</button>
                </div>
                <div class="c">
                    <h2 style="text-align:center;margin-bottom:3rem;font-size:2.5rem;">¿Por Qué Elegirnos?</h2>
                    <div class="feature-grid">
                        <div class="feature-item">
                            <div class="feature-icon">🚚</div>
                            <h3>Envío Rápido</h3>
                            <p>Entrega en tiempo récord a todo el país</p>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">💎</div>
                            <h3>Calidad Premium</h3>
                            <p>Solo productos de la más alta calidad</p>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">🛡️</div>
                            <h3>Garantía Total</h3>
                            <p>Satisfacción 100% garantizada</p>
                        </div>
                    </div>
                </div>
            </div>
        `,
        testimonials: `
            <div class="testimonials-section editable-section" id="${sectionId}" data-section="testimonials">
                <div class="section-controls">
                    <button class="section-control-btn" onclick="editWixSection(this)">✏️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'up')">⬆️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'down')">⬇️</button>
                    <button class="section-control-btn" onclick="deleteWixSection(this)">🗑️</button>
                </div>
                <div class="c">
                    <h2 style="text-align:center;margin-bottom:3rem;font-size:2.5rem;">Lo Que Dicen Nuestros Clientes</h2>
                    <div class="testimonial-grid">
                        <div class="testimonial-item">
                            <p style="font-style:italic;margin-bottom:1rem;">"Excelente servicio y productos de calidad. Muy recomendado."</p>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <div style="width:40px;height:40px;background:var(--accent-color);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">M</div>
                                <div>
                                    <div style="font-weight:bold;">María González</div>
                                    <div style="font-size:0.9rem;color:#666;">Cliente Verificada</div>
                                </div>
                            </div>
                        </div>
                        <div class="testimonial-item">
                            <p style="font-style:italic;margin-bottom:1rem;">"Compra fácil y entrega súper rápida. ¡Volveré a comprar!"</p>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <div style="width:40px;height:40px;background:var(--secondary-color);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">J</div>
                                <div>
                                    <div style="font-weight:bold;">Juan Pérez</div>
                                    <div style="font-size:0.9rem;color:#666;">Cliente Frecuente</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        cta: `
            <div class="cta-section editable-section" id="${sectionId}" data-section="cta">
                <div class="section-controls">
                    <button class="section-control-btn" onclick="editWixSection(this)">✏️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'up')">⬆️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'down')">⬇️</button>
                    <button class="section-control-btn" onclick="deleteWixSection(this)">🗑️</button>
                </div>
                <div class="c">
                    <h2 style="font-size:2.5rem;margin-bottom:1rem;">¿Listo para Comenzar?</h2>
                    <p style="font-size:1.2rem;margin-bottom:2rem;opacity:0.9;">Únete a miles de clientes satisfechos</p>
                    <button class="btn" style="font-size:1.2rem;padding:1rem 2rem;background:white;color:var(--accent-color);">Explorar Ahora</button>
                </div>
            </div>
        `,
        gallery: `
            <div class="editable-section" id="${sectionId}" data-section="gallery" style="padding:3rem 0;background:white;">
                <div class="section-controls">
                    <button class="section-control-btn" onclick="editWixSection(this)">✏️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'up')">⬆️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'down')">⬇️</button>
                    <button class="section-control-btn" onclick="deleteWixSection(this)">🗑️</button>
                </div>
                <div class="c">
                    <h2 style="text-align:center;margin-bottom:3rem;font-size:2.5rem;">Galería de Productos</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;">
                        <div style="height:200px;background:#f8f9fa;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#666;">🖼️ Imagen 1</div>
                        <div style="height:200px;background:#f8f9fa;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#666;">🖼️ Imagen 2</div>
                        <div style="height:200px;background:#f8f9fa;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#666;">🖼️ Imagen 3</div>
                        <div style="height:200px;background:#f8f9fa;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#666;">🖼️ Imagen 4</div>
                    </div>
                </div>
            </div>
        `,
        contact: `
            <div class="editable-section" id="${sectionId}" data-section="contact" style="padding:3rem 0;background:#f8f9fa;">
                <div class="section-controls">
                    <button class="section-control-btn" onclick="editWixSection(this)">✏️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'up')">⬆️</button>
                    <button class="section-control-btn" onclick="moveWixSection(this, 'down')">⬇️</button>
                    <button class="section-control-btn" onclick="deleteWixSection(this)">🗑️</button>
                </div>
                <div class="c">
                    <h2 style="text-align:center;margin-bottom:3rem;font-size:2.5rem;">Contáctanos</h2>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem;">
                        <div style="background:white;padding:2rem;border-radius:8px;text-align:center;">
                            <div style="font-size:3rem;margin-bottom:1rem;">📧</div>
                            <h3>Email</h3>
                            <p>info@mitienda.com</p>
                        </div>
                        <div style="background:white;padding:2rem;border-radius:8px;text-align:center;">
                            <div style="font-size:3rem;margin-bottom:1rem;">📱</div>
                            <h3>Teléfono</h3>
                            <p>+506 8888-8888</p>
                        </div>
                        <div style="background:white;padding:2rem;border-radius:8px;text-align:center;">
                            <div style="font-size:3rem;margin-bottom:1rem;">📍</div>
                            <h3>Ubicación</h3>
                            <p>San José, Costa Rica</p>
                        </div>
                    </div>
                </div>
            </div>
        `
    };
    
    if (sectionTemplates[sectionType]) {
        const dynamicSections = document.getElementById('dynamicSections');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = sectionTemplates[sectionType];
        dynamicSections.appendChild(tempDiv.firstElementChild);
        
        updateCurrentSectionsList();
        showAlert(`Sección ${sectionType} agregada correctamente`, 'success');
        saveWixDesignToStorage();
    }
}

function editWixSection(button) {
    const section = button.closest('.editable-section');
    if (!section) return;
    
    selectedWixElement = section;
    showWixElementEditor(section);
}

function showWixElementEditor(element) {
    const elementEditor = document.getElementById('selectedElementEditor');
    const elementProperties = document.getElementById('elementProperties');
    
    elementEditor.style.display = 'block';
    
    // Cambiar a la pestaña de elementos
    showWixTab('elements');
    
    // Generar controles según el tipo de elemento
    const sectionType = element.dataset.section;
    
    elementProperties.innerHTML = `
        <div class="wix-property-group">
            <h5>🎨 Color de Fondo</h5>
            <input type="color" id="elementBgColor" value="#ffffff" onchange="updateElementStyle('backgroundColor', this.value)">
        </div>
        
        <div class="wix-property-group">
            <h5>📏 Espaciado</h5>
            <div class="wix-slider-container">
                <input type="range" class="wix-slider" min="0" max="100" value="48" id="elementPadding" onchange="updateElementStyle('paddingTop', this.value + 'px'); updateElementStyle('paddingBottom', this.value + 'px')">
                <div class="wix-slider-label">
                    <span>0px</span>
                    <span>Padding</span>
                    <span>100px</span>
                </div>
            </div>
        </div>
        
        <div class="wix-property-group">
            <h5>✏️ Editar Texto</h5>
            <button class="btn" onclick="enableTextEditing()" style="width:100%;">Habilitar Edición de Texto</button>
        </div>
        
        <div class="wix-property-group">
            <button class="btn btn-danger" onclick="deleteWixSection(selectedWixElement.querySelector('.section-control-btn'))" style="width:100%;">🗑️ Eliminar Sección</button>
        </div>
    `;
}

function updateElementStyle(property, value) {
    if (selectedWixElement) {
        selectedWixElement.style[property] = value;
        saveWixDesignToStorage();
    }
}

function enableTextEditing() {
    if (!selectedWixElement) return;
    
    const textElements = selectedWixElement.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, div');
    
    textElements.forEach(element => {
        if (!element.querySelector('button') && !element.classList.contains('section-controls')) {
            element.contentEditable = true;
            element.style.outline = '2px dashed var(--accent-color)';
            element.addEventListener('blur', function() {
                this.contentEditable = false;
                this.style.outline = 'none';
                saveWixDesignToStorage();
            });
        }
    });
    
    showAlert('Modo de edición de texto activado. Haz clic en cualquier texto para editarlo.', 'success');
}

function moveWixSection(button, direction) {
    const section = button.closest('.editable-section');
    const container = section.parentElement;
    
    if (direction === 'up' && section.previousElementSibling) {
        container.insertBefore(section, section.previousElementSibling);
    } else if (direction === 'down' && section.nextElementSibling) {
        container.insertBefore(section.nextElementSibling, section);
    }
    
    updateCurrentSectionsList();
    saveWixDesignToStorage();
}

function deleteWixSection(button) {
    if (confirm('¿Estás seguro de que quieres eliminar esta sección?')) {
        const section = button.closest('.editable-section');
        section.remove();
        updateCurrentSectionsList();
        saveWixDesignToStorage();
        showAlert('Sección eliminada', 'success');
    }
}

function updateCurrentSectionsList() {
    const currentSectionsList = document.getElementById('currentSectionsList');
    const sections = document.querySelectorAll('.editable-section');
    
    if (sections.length === 0) {
        currentSectionsList.innerHTML = '<p style="color:#666;font-style:italic;">No hay secciones personalizadas agregadas.</p>';
        return;
    }
    
    currentSectionsList.innerHTML = Array.from(sections).map((section, index) => {
        const sectionType = section.dataset.section || 'personalizada';
        const sectionTitle = section.querySelector('h1, h2, h3')?.textContent?.substring(0, 30) || `Sección ${sectionType}`;
        
        return `
            <div style="background:white;border:1px solid #ddd;border-radius:6px;padding:1rem;margin-bottom:0.5rem;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-weight:bold;">${sectionTitle}</div>
                    <div style="font-size:0.85rem;color:#666;">Tipo: ${sectionType}</div>
                </div>
                <div style="display:flex;gap:0.25rem;">
                    <button class="section-control-btn" onclick="editSectionByIndex(${index})" title="Editar">✏️</button>
                    <button class="section-control-btn" onclick="deleteSectionByIndex(${index})" title="Eliminar">🗑️</button>
                </div>
            </div>
        `;
    }).join('');
}

function editSectionByIndex(index) {
    const sections = document.querySelectorAll('.editable-section');
    if (sections[index]) {
        editWixSection(sections[index].querySelector('.section-control-btn'));
    }
}

function deleteSectionByIndex(index) {
    const sections = document.querySelectorAll('.editable-section');
    if (sections[index]) {
        deleteWixSection(sections[index].querySelector('.section-control-btn'));
    }
}

// SISTEMA DE PLANTILLAS WIX
function applyPageTemplate(templateName) {
    if (!confirm('¿Aplicar esta plantilla? Se reemplazará el contenido actual de la página.')) {
        return;
    }
    
    // Limpiar secciones existentes
    document.getElementById('dynamicSections').innerHTML = '';
    wixSectionCounter = 0;
    
    // Aplicar plantilla según el tipo
    switch (templateName) {
        case 'ecommerce':
            addWixSection('hero');
            addWixSection('features');
            addWixSection('testimonials');
            addWixSection('cta');
            applyWixTheme('modern');
            break;
        case 'minimal':
            addWixSection('hero');
            addWixSection('gallery');
            addWixSection('contact');
            applyWixTheme('elegant');
            break;
        case 'corporate':
            addWixSection('hero');
            addWixSection('features');
            addWixSection('contact');
            applyWixTheme('nature');
            break;
        case 'creative':
            addWixSection('hero');
            addWixSection('gallery');
            addWixSection('testimonials');
            addWixSection('cta');
            applyWixTheme('dark');
            break;
    }
    
    showAlert(`Plantilla ${templateName} aplicada correctamente`, 'success');
}

// SISTEMA DE ELEMENTOS WIX
function addWixElement(elementType) {
    const elements = {
        text: '<div class="wix-element" contenteditable="true" style="padding:1rem;background:#f8f9fa;border:2px dashed #ddd;margin:1rem 0;border-radius:4px;">Haz clic para editar este texto</div>',
        image: '<div class="wix-element" style="padding:1rem;background:#f8f9fa;border:2px dashed #ddd;margin:1rem 0;border-radius:4px;text-align:center;height:200px;display:flex;align-items:center;justify-content:center;color:#666;">🖼️ Imagen - Haz clic para cambiar</div>',
        button: '<div class="wix-element" style="text-align:center;margin:1rem 0;"><button class="btn" onclick="alert(\'Configura la acción del botón\')">Botón Personalizado</button></div>',
        divider: '<div class="wix-element" style="margin:2rem 0;"><hr style="border:none;height:2px;background:var(--accent-color);border-radius:2px;"></div>',
        spacer: '<div class="wix-element" style="height:50px;background:transparent;margin:1rem 0;border:1px dashed #ddd;display:flex;align-items:center;justify-content:center;color:#999;font-size:0.8rem;">Espaciador - 50px</div>',
        video: '<div class="wix-element" style="padding:1rem;background:#f8f9fa;border:2px dashed #ddd;margin:1rem 0;border-radius:4px;text-align:center;height:250px;display:flex;align-items:center;justify-content:center;color:#666;">🎥 Video - Configura URL</div>'
    };
    
    if (elements[elementType]) {
        const dropZone = document.getElementById('mainDropZone');
        dropZone.classList.remove('hidden');
        dropZone.innerHTML = `
            <div>${elements[elementType]}</div>
            <button class="btn" onclick="confirmAddElement('${elementType}')">✅ Agregar Elemento</button>
            <button class="btn btn-danger" onclick="cancelAddElement()">❌ Cancelar</button>
        `;
        dropZone.scrollIntoView({ behavior: 'smooth' });
    }
}

function confirmAddElement(elementType) {
    const dropZone = document.getElementById('mainDropZone');
    const elementHtml = dropZone.querySelector('div').innerHTML;
    
    // Agregar al contenedor de secciones dinámicas
    const dynamicSections = document.getElementById('dynamicSections');
    const wrapper = document.createElement('div');
    wrapper.innerHTML = elementHtml;
    dynamicSections.appendChild(wrapper.firstElementChild);
    
    // Ocultar drop zone
    cancelAddElement();
    
    showAlert(`Elemento ${elementType} agregado correctamente`, 'success');
    saveWixDesignToStorage();
}

function cancelAddElement() {
    const dropZone = document.getElementById('mainDropZone');
    dropZone.classList.add('hidden');
    dropZone.innerHTML = '<div>📋 Arrastra aquí para agregar una nueva sección</div>';
}

// FUNCIONES DE PERSISTENCIA WIX
function saveWixDesignToStorage() {
    const wixDesignData = {
        styles: wixCustomStyles,
        sections: document.getElementById('dynamicSections').innerHTML,
        sectionCounter: wixSectionCounter,
        timestamp: new Date().toISOString()
    };
    
    try {
        localStorage.setItem('wixMiniTiendaDesign', JSON.stringify(wixDesignData));
    } catch (error) {
        console.error('Error guardando diseño Wix:', error);
    }
}

function loadWixDesignFromStorage() {
    try {
        const savedDesign = localStorage.getItem('wixMiniTiendaDesign');
        if (savedDesign) {
            const designData = JSON.parse(savedDesign);
            
            // Restaurar estilos
            if (designData.styles) {
                wixCustomStyles = designData.styles;
                Object.entries(wixCustomStyles).forEach(([property, value]) => {
                    if (property.startsWith('--')) {
                        document.documentElement.style.setProperty(property, value);
                    } else if (property === 'base-font-size') {
                        document.documentElement.style.fontSize = value;
                    }
                });
            }
            
            // Restaurar secciones
            if (designData.sections) {
                document.getElementById('dynamicSections').innerHTML = designData.sections;
            }
            
            // Restaurar contador
            if (designData.sectionCounter) {
                wixSectionCounter = designData.sectionCounter;
            }
            
            return true;
        }
    } catch (error) {
        console.error('Error cargando diseño Wix guardado:', error);
    }
    return false;
}

function saveWixDesign() {
    const designData = {
        styles: wixCustomStyles,
        sections: document.getElementById('dynamicSections').innerHTML,
        sectionCounter: wixSectionCounter,
        version: '2.0',
        timestamp: new Date().toISOString(),
        siteName: document.getElementById('sn').textContent
    };
    
    const dataStr = JSON.stringify(designData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `wix-design-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showAlert('💾 Diseño Wix exportado exitosamente', 'success');
}

function loadWixDesign() {
    document.getElementById('wixDesignFile').click();
}

function handleWixDesignImport(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const designData = JSON.parse(e.target.result);
            
            if (confirm('¿Cargar este diseño? Se reemplazará el diseño actual.')) {
                // Restaurar estilos
                if (designData.styles) {
                    wixCustomStyles = designData.styles;
                    Object.entries(wixCustomStyles).forEach(([property, value]) => {
                        if (property.startsWith('--')) {
                            document.documentElement.style.setProperty(property, value);
                        } else if (property === 'base-font-size') {
                            document.documentElement.style.fontSize = value;
                        }
                    });
                }
                
                // Restaurar secciones
                if (designData.sections) {
                    document.getElementById('dynamicSections').innerHTML = designData.sections;
                }
                
                // Restaurar contador
                if (designData.sectionCounter) {
                    wixSectionCounter = designData.sectionCounter;
                }
                
                updateWixColorInputs();
                updateCurrentSectionsList();
                saveWixDesignToStorage();
                showAlert('📥 Diseño Wix cargado exitosamente', 'success');
            }
        } catch (error) {
            console.error('Error cargando diseño Wix:', error);
            showAlert('❌ Error cargando archivo de diseño Wix', 'error');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function resetWixDesign() {
    if (confirm('¿Restablecer todo el diseño Wix? Se perderán todos los cambios.')) {
        if (confirm('🚨 ÚLTIMA CONFIRMACIÓN: Se eliminarán todas las secciones personalizadas y estilos. ¿Continuar?')) {
            // Limpiar estilos
            Object.keys(wixCustomStyles).forEach(property => {
                if (property.startsWith('--')) {
                    document.documentElement.style.removeProperty(property);
                } else if (property === 'base-font-size') {
                    document.documentElement.style.fontSize = '';
                }
            });
            
            wixCustomStyles = {};
            wixSectionCounter = 0;
            
            // Limpiar secciones
            document.getElementById('dynamicSections').innerHTML = '';
            
            // Restablecer inputs
            document.getElementById('customPrimaryColor').value = '#2c3e50';
            document.getElementById('customSecondaryColor').value = '#3498db';
            document.getElementById('customAccentColor').value = '#27ae60';
            document.getElementById('wixFontSelect').value = 'Arial, sans-serif';
            document.getElementById('baseFontSize').value = 16;
            document.getElementById('borderRadiusSlider').value = 4;
            document.getElementById('shadowIntensity').value = 'light';
            
            updateCurrentSectionsList();
            saveWixDesignToStorage();
            showAlert('🔄 Diseño Wix restablecido completamente', 'success');
        }
    }
}

// FUNCIÓN PARA MOSTRAR/OCULTAR EL EDITOR SEGÚN EL USUARIO
function updateWixEditorVisibility() {
    const editorToggle = document.getElementById('wixEditorToggle');
    
    if (user && user.role === 'admin') {
        editorToggle.style.display = 'flex';
    } else {
        editorToggle.style.display = 'none';
        // Cerrar editor si estaba abierto
        const editorPanel = document.getElementById('wixEditorPanel');
        if (editorPanel.classList.contains('open')) {
            toggleWixEditor();
        }
    }
}

// RESTO DEL CÓDIGO ORIGINAL (variables y funciones existentes)
let products=[
{id:1,name:"Laptop Gaming",desc:"Laptop para gaming de alta gama",price:899.99,paypalUrl:"https://paypal.me/shop/899",imageUrl:"https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=400&h=300&fit=crop",shipping:{type:"free",price:0},delivery:{type:"preset",presetId:"china-standard"},source:{platform:"aliexpress",url:"https://es.aliexpress.com/item/example",costPrice:450.00,notes:"Proveedor confiable, buenos reviews"},category:"electronica"},
{id:2,name:"Mouse RGB Gaming",desc:"Mouse gaming con iluminación RGB",price:49.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?w=400&h=300&fit=crop",shipping:{type:"paid",price:5.99},delivery:{type:"custom",minDays:3,maxDays:7,origin:"USA"},source:{platform:"amazon",url:"",costPrice:25.00,notes:""},category:"electronica"},
{id:3,name:"Teclado Mecánico",desc:"Teclado mecánico para gaming",price:79.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1541140532154-b024d705b90a?w=400&h=300&fit=crop",shipping:{type:"free",price:0},delivery:{type:"preset",presetId:"china-express"},source:{platform:"dhgate",url:"",costPrice:35.00,notes:""},category:"electronica"},
{id:4,name:"Monitor 4K",desc:"Monitor 4K de 27 pulgadas",price:329.99,paypalUrl:"https://paypal.me/shop/329",imageUrl:"https://images.unsplash.com/photo-1527443224154-c4a3942d3acf?w=400&h=300&fit=crop",shipping:{type:"paid",price:15.99},delivery:{type:"preset",presetId:"china-standard"},source:{platform:"alibaba",url:"",costPrice:180.00,notes:"Requiere orden mínima de 5 unidades"},category:"electronica"},
{id:5,name:"Cama para Perros",desc:"Cama cómoda y suave para mascotas",price:45.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1583337130417-3346a1be7dee?w=400&h=300&fit=crop",shipping:{type:"free",price:0},delivery:{type:"preset",presetId:"china-standard"},source:{platform:"aliexpress",url:"",costPrice:20.00,notes:""},category:"mascotas"},
{id:6,name:"Maceta Decorativa",desc:"Maceta moderna para plantas de interior",price:29.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1485955900006-10f4d324d411?w=400&h=300&fit=crop",shipping:{type:"paid",price:8.99},delivery:{type:"custom",minDays:5,maxDays:12,origin:"México"},source:{platform:"amazon",url:"",costPrice:15.00,notes:""},category:"jardineria"},
{id:7,name:"Camiseta Básica",desc:"Camiseta de algodón 100% suave",price:19.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=300&fit=crop",shipping:{type:"free",price:0},delivery:{type:"preset",presetId:"china-express"},source:{platform:"aliexpress",url:"",costPrice:8.00,notes:""},category:"ropa"},
{id:8,name:"Organizador de Auto",desc:"Organizador multifuncional para vehículos",price:24.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=400&h=300&fit=crop",shipping:{type:"paid",price:6.99},delivery:{type:"custom",minDays:7,maxDays:14,origin:"China"},source:{platform:"aliexpress",url:"",costPrice:12.00,notes:""},category:"autos"},
{id:9,name:"Lámpara LED",desc:"Lámpara LED moderna para el hogar",price:34.99,paypalUrl:"",imageUrl:"https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=300&fit=crop",shipping:{type:"free",price:0},delivery:{type:"preset",presetId:"china-standard"},source:{platform:"dhgate",url:"",costPrice:18.00,notes:""},category:"hogar"}
];

let cart=[],user=null,sales=0;
let paypalConfig = {clientId: 'ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn', mode: 'live'};
let emailConfig = {
    adminEmail: 'admin@mitienda.com',
    service: 'emailjs',
    emailjsServiceId: '',
    emailjsTemplateId: '',
    emailjsTemplateConfirm: '',
    emailjsPublicKey: ''
};

// Sistema de presets de entrega
let deliveryPresets = [
    {id: 'china-standard', name: 'China Estándar', minDays: 7, maxDays: 15, origin: 'China'},
    {id: 'china-express', name: 'China Express', minDays: 5, maxDays: 10, origin: 'China'},
    {id: 'usa-standard', name: 'USA Estándar', minDays: 3, maxDays: 7, origin: 'Estados Unidos'},
    {id: 'europa-standard', name: 'Europa Estándar', minDays: 5, maxDays: 12, origin: 'Europa'}
];

const t={
es:{
    sn:'MiniTienda',sb:'Tienda',cb:'Carrito',lb:'Login',ob:'Logout',pt:'Productos',ct2:'Carrito',tt:'Total',lt:'Login',pl:'Contraseña',lab:'Login',cb3:'Crear',rt:'Registro',nl:'Nombre',rb:'Crear',at:'Admin',apt:'Agregar',apb:'Agregar',add:'Agregar',buy:'Comprar Ahora',edit:'Editar',del:'Eliminar',welcome:'Hola',noimg:'Sin imagen',cl:'Máximo 15 productos en el carrito',cartLimit:'No puedes agregar más de 15 productos',itemsInCart:'productos en carrito',buyNow:'🛒 Comprar Ahora','phone-label':'Teléfono','cedula-label':'Cédula/ID','address-label':'Dirección de Envío',buyDirect:'Comprar',directPayment:'O pagar directamente con PayPal:',buyWithCard:'Comprar con PayPal o Tarjeta',
    'ty-title':'¡Gracias por Registrarte!','ty-activate-title':'¿Ya tienes tu código de activación?','ty-activate-desc':'Ingresa el código que recibiste por email:',
    accountPending:'Cuenta pendiente de activación',accountActive:'Cuenta activa',mustActivate:'Debes activar tu cuenta para comprar',
    freeShipping:'Envío Gratis',shippingCost:'Envío:','subtotal-label':'Subtotal:','shipping-label':'Envío:',
    deliveryTime:'Entrega:','categories-title':'Categorías','filter-label':'Filtrar por:','clear-filters':'Limpiar filtros'
},
en:{
    sn:'MiniStore',sb:'Shop',cb:'Cart',lb:'Login',ob:'Logout',pt:'Products',ct2:'Cart',tt:'Total',lt:'Sign In',pl:'Password',lab:'Sign In',cb3:'Create',rt:'Register',nl:'Name',rb:'Create',at:'Admin',apt:'Add Product',apb:'Add',add:'Add',buy:'Buy Now',edit:'Edit',del:'Delete',welcome:'Hello',noimg:'No image',cl:'Maximum 15 products in cart',cartLimit:'Cannot add more than 15 products',itemsInCart:'items in cart',buyNow:'🛒 Buy Now','phone-label':'Phone','cedula-label':'ID Number','address-label':'Shipping Address',buyDirect:'Buy',directPayment:'Or pay directly with PayPal:',buyWithCard:'Buy with PayPal or Card',
    'ty-title':'Thank You for Signing Up!','ty-activate-title':'Already have your activation code?','ty-activate-desc':'Enter the code you received by email:',
    accountPending:'Account pending activation',accountActive:'Active account',mustActivate:'You must activate your account to purchase',
    freeShipping:'Free Shipping',shippingCost:'Shipping:','subtotal-label':'Subtotal:','shipping-label':'Shipping:',
    deliveryTime:'Delivery:','categories-title':'Categories','filter-label':'Filter by:','clear-filters':'Clear filters'
}
};

// ===== FUNCIONES DE CATEGORÍAS PROTEGIDAS =====
function loadCategories() {
    const grid = document.getElementById('categories-grid');
    const filter = document.getElementById('category-filter');
    const categoriesSection = document.getElementById('categories-section-container');
    
    // Solo mostrar controles de edición para admin
    if (user && user.role === 'admin' && wixEditMode) {
        categoriesSection.classList.add('editable-section');
        categoriesSection.dataset.section = 'categories';
        
        // Agregar controles si no existen
        if (!categoriesSection.querySelector('.section-controls')) {
            const controls = document.createElement('div');
            controls.className = 'section-controls';
            controls.innerHTML = `
                <button class="section-control-btn" onclick="editCategoriesSection(this)" title="Configurar Categorías">⚙️</button>
                <button class="section-control-btn" onclick="toggleCategoriesVisibility()" title="Mostrar/Ocultar">👁️</button>
            `;
            categoriesSection.insertBefore(controls, categoriesSection.firstChild);
        }
    } else {
        categoriesSection.classList.remove('editable-section');
        delete categoriesSection.dataset.section;
        
        // Remover controles si existen
        const controls = categoriesSection.querySelector('.section-controls');
        if (controls) {
            controls.remove();
        }
    }
    
    grid.innerHTML = Object.values(categories).map(cat => {
        const count = products.filter(p => p.category === cat.id).length;
        const isClickable = !wixEditMode || (user && user.role === 'admin');
        const isDisabled = wixEditMode && user?.role !== 'admin';
        
        return `
        <div class="category-card ${selectedCategory === cat.id ? 'active' : ''} ${isDisabled ? 'disabled' : ''}" 
             ${isClickable ? `onclick="selectCategory('${cat.id}')"` : ''}>
            <span class="category-icon">${cat.icon}</span>
            <div class="category-name">${cat.name[lang]}</div>
            <div class="category-count">${count} productos</div>
        </div>
        `;
    }).join('');
    
    filter.innerHTML = `
        <option value="">Todas las categorías</option>
        ${Object.values(categories).map(cat => 
            `<option value="${cat.id}" ${selectedCategory === cat.id ? 'selected' : ''}>${cat.name[lang]}</option>`
        ).join('')}
    `;
}

function selectCategory(categoryId) {
    // Solo permitir selección si no está en modo edición o es admin
    if (wixEditMode && user?.role !== 'admin') {
        return;
    }
    
    if (selectedCategory === categoryId) {
        selectedCategory = '';
    } else {
        selectedCategory = categoryId;
    }
    
    loadCategories();
    loadProducts();
    document.getElementById('category-filter').value = selectedCategory;
}

function filterByCategory() {
    // Solo permitir filtrado si no está en modo edición o es admin
    if (wixEditMode && user?.role !== 'admin') {
        return;
    }
    
    selectedCategory = document.getElementById('category-filter').value;
    loadCategories();
    loadProducts();
}

function clearAllFilters() {
    // Solo permitir limpiar filtros si no está en modo edición o es admin
    if (wixEditMode && user?.role !== 'admin') {
        return;
    }
    
    selectedCategory = '';
    loadCategories();
    loadProducts();
    document.getElementById('category-filter').value = '';
}

function editCategoriesSection(button) {
    if (!user || user.role !== 'admin') {
        showAlert('Solo los administradores pueden configurar las categorías', 'error');
        return;
    }
    
    // Abrir modal de configuración de categorías
    document.getElementById('mc2').innerHTML = `
        <div style="max-width:500px;margin:0 auto;">
            <h2 style="text-align:center;margin-bottom:2rem;color:var(--primary-color);">⚙️ Configuración de Categorías</h2>
            
            <div style="background:#f8f9fa;padding:1.5rem;border-radius:8px;margin-bottom:2rem;">
                <h3 style="margin-bottom:1rem;color:var(--text-color);">📊 Estado Actual</h3>
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1rem;">
                    <div style="text-align:center;padding:1rem;background:white;border-radius:6px;">
                        <div style="font-size:2rem;color:var(--accent-color);">${Object.keys(categories).length}</div>
                        <div style="font-size:0.9rem;color:#666;">Categorías Activas</div>
                    </div>
                    <div style="text-align:center;padding:1rem;background:white;border-radius:6px;">
                        <div style="font-size:2rem;color:var(--secondary-color);">${products.length}</div>
                        <div style="font-size:0.9rem;color:#666;">Total Productos</div>
                    </div>
                </div>
            </div>
            
            <div style="background:#e8f5e8;padding:1.5rem;border-radius:8px;border-left:4px solid var(--accent-color);margin-bottom:2rem;">
                <h3 style="margin-bottom:1rem;color:var(--text-color);">🔒 Control de Acceso</h3>
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem;">
                    <input type="checkbox" id="categories-admin-only" ${wixEditMode ? 'checked' : ''} onchange="toggleCategoriesAdminMode(this.checked)">
                    <label for="categories-admin-only" style="font-weight:500;">Solo administradores pueden interactuar con categorías</label>
                </div>
                <p style="font-size:0.9rem;color:#666;margin-bottom:0;">
                    Cuando está activado, los clientes solo pueden ver las categorías pero no seleccionarlas. 
                    Los administradores mantienen control total.
                </p>
            </div>
            
            <div style="background:#fff3cd;padding:1.5rem;border-radius:8px;border-left:4px solid var(--warning-color);">
                <h3 style="margin-bottom:1rem;color:var(--text-color);">📋 Categorías Disponibles</h3>
                <div style="display:grid;gap:0.5rem;">
                    ${Object.values(categories).map(cat => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem;background:white;border-radius:4px;border:1px solid #ddd;">
                            <div style="display:flex;align-items:center;gap:1rem;">
                                <span style="font-size:1.5rem;">${cat.icon}</span>
                                <div>
                                    <div style="font-weight:bold;">${cat.name[lang]}</div>
                                    <div style="font-size:0.8rem;color:#666;">${products.filter(p => p.category === cat.id).length} productos</div>
                                </div>
                            </div>
                            <div style="color:var(--accent-color);font-weight:bold;">Activa</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="text-align:center;margin-top:2rem;">
                <button class="btn" onclick="closeModal()" style="background:var(--secondary-color);">✅ Guardar Configuración</button>
            </div>
        </div>
    `;
    
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal').style.display = 'flex';
}

function toggleCategoriesAdminMode(isAdminOnly) {
    // Esta función se puede usar para futuras funcionalidades de configuración
    if (isAdminOnly) {
        showAlert('Modo administrador activado para categorías', 'success');
    } else {
        showAlert('Los clientes pueden interactuar con categorías', 'success');
    }
    
    loadCategories();
    saveWixDesignToStorage();
}

function toggleCategoriesVisibility() {
    const categoriesSection = document.getElementById('categories-section-container');
    const isHidden = categoriesSection.style.display === 'none';
    
    if (isHidden) {
        categoriesSection.style.display = 'block';
        showAlert('Sección de categorías mostrada', 'success');
    } else {
        categoriesSection.style.display = 'none';
        showAlert('Sección de categorías ocultada', 'success');
    }
    
    saveWixDesignToStorage();
}

function getFilteredProducts() {
    if (!selectedCategory) {
        return products;
    }
    return products.filter(p => p.category === selectedCategory);
}

// ===== FUNCIONES DE GESTIÓN DE PRESETS DE ENTREGA =====
function addDeliveryPreset() {
    const name = document.getElementById('delivery-preset-name').value.trim();
    const minDays = parseInt(document.getElementById('delivery-min-days').value);
    const maxDays = parseInt(document.getElementById('delivery-max-days').value);
    const origin = document.getElementById('delivery-origin').value.trim();

    if (!name || !minDays || !maxDays || !origin) {
        showAlert('Todos los campos del preset son requeridos', 'error');
        return;
    }

    if (minDays >= maxDays) {
        showAlert('Los días máximos deben ser mayores que los mínimos', 'error');
        return;
    }

    const id = 'preset-' + Date.now();
    const newPreset = { id, name, minDays, maxDays, origin };
    deliveryPresets.push(newPreset);

    document.getElementById('delivery-preset-name').value = '';
    document.getElementById('delivery-min-days').value = '';
    document.getElementById('delivery-max-days').value = '';
    document.getElementById('delivery-origin').value = '';

    saveToStorage();
    loadDeliveryPresets();
    updateProductDeliverySelect();
    showAlert('Preset de entrega agregado exitosamente', 'success');
}

function editDeliveryPreset(presetId) {
    const preset = deliveryPresets.find(p => p.id === presetId);
    if (!preset) return;

    document.getElementById('delivery-preset-name').value = preset.name;
    document.getElementById('delivery-min-days').value = preset.minDays;
    document.getElementById('delivery-max-days').value = preset.maxDays;
    document.getElementById('delivery-origin').value = preset.origin;

    const addBtn = document.querySelector('.af.delivery-management .btn');
    addBtn.textContent = '💾 Actualizar Preset';
    addBtn.onclick = () => updateDeliveryPreset(presetId);
}

function updateDeliveryPreset(presetId) {
    const name = document.getElementById('delivery-preset-name').value.trim();
    const minDays = parseInt(document.getElementById('delivery-min-days').value);
    const maxDays = parseInt(document.getElementById('delivery-max-days').value);
    const origin = document.getElementById('delivery-origin').value.trim();

    if (!name || !minDays || !maxDays || !origin) {
        showAlert('Todos los campos del preset son requeridos', 'error');
        return;
    }

    if (minDays >= maxDays) {
        showAlert('Los días máximos deben ser mayores que los mínimos', 'error');
        return;
    }

    const presetIndex = deliveryPresets.findIndex(p => p.id === presetId);
    if (presetIndex !== -1) {
        deliveryPresets[presetIndex] = { id: presetId, name, minDays, maxDays, origin };
        
        document.getElementById('delivery-preset-name').value = '';
        document.getElementById('delivery-min-days').value = '';
        document.getElementById('delivery-max-days').value = '';
        document.getElementById('delivery-origin').value = '';
        
        const addBtn = document.querySelector('.af.delivery-management .btn');
        addBtn.textContent = '➕ Agregar Preset';
        addBtn.onclick = addDeliveryPreset;

        saveToStorage();
        loadDeliveryPresets();
        updateProductDeliverySelect();
        showAlert('Preset actualizado exitosamente', 'success');
    }
}

function deleteDeliveryPreset(presetId) {
    if (confirm('¿Estás seguro de que quieres eliminar este preset?')) {
        deliveryPresets = deliveryPresets.filter(p => p.id !== presetId);
        saveToStorage();
        loadDeliveryPresets();
        updateProductDeliverySelect();
        showAlert('Preset eliminado', 'success');
    }
}

function loadDeliveryPresets() {
    const container = document.getElementById('delivery-presets-list');
    if (deliveryPresets.length === 0) {
        container.innerHTML = '<p style="color:#666;font-style:italic;">No hay presets configurados.</p>';
        return;
    }

    container.innerHTML = deliveryPresets.map(preset => `
        <div class="delivery-preset">
            <div>
                <div class="delivery-preset-name">${preset.name}</div>
                <div class="delivery-preset-info">
                    ${preset.minDays}-${preset.maxDays} días hábiles • Desde ${preset.origin}
                </div>
            </div>
            <div class="delivery-preset-actions">
                <button class="delivery-preset-edit" onclick="editDeliveryPreset('${preset.id}')">✏️</button>
                <button class="delivery-preset-delete" onclick="deleteDeliveryPreset('${preset.id}')">🗑️</button>
            </div>
        </div>
    `).join('');

    document.getElementById('delivery-presets-count').textContent = deliveryPresets.length;
}

function updateProductDeliverySelect() {
    const select = document.getElementById('product-delivery-preset');
    select.innerHTML = '<option value="">Seleccionar...</option>' + 
        deliveryPresets.map(preset => 
            `<option value="${preset.id}">${preset.name} (${preset.minDays}-${preset.maxDays} días)</option>`
        ).join('');
}

function toggleDeliveryType() {
    const presetOption = document.getElementById('delivery-preset-option');
    const presetSelector = document.getElementById('delivery-preset-selector');
    const customInputs = document.getElementById('delivery-custom-inputs');

    if (presetOption.checked) {
        presetSelector.classList.remove('hidden');
        customInputs.classList.add('hidden');
    } else {
        presetSelector.classList.add('hidden');
        customInputs.classList.remove('hidden');
    }
}

function getDeliveryInfo(product) {
    if (!product.delivery) return null;

    if (product.delivery.type === 'preset') {
        const preset = deliveryPresets.find(p => p.id === product.delivery.presetId);
        if (preset) {
            return {
                minDays: preset.minDays,
                maxDays: preset.maxDays,
                origin: preset.origin
            };
        }
    } else if (product.delivery.type === 'custom') {
        return {
            minDays: product.delivery.minDays,
            maxDays: product.delivery.maxDays,
            origin: product.delivery.origin
        };
    }
    
    return null;
}

// ===== FUNCIONES DE ENVÍO =====
function toggleShippingPrice() {
    const paidRadio = document.getElementById('shipping-paid');
    const priceContainer = document.getElementById('shipping-price-container');
    
    if (paidRadio.checked) {
        priceContainer.classList.remove('hidden');
    } else {
        priceContainer.classList.add('hidden');
        document.getElementById('shipping-price').value = '';
    }
}

function calculateShipping(cartItems) {
    let totalShipping = 0;
    
    cartItems.forEach(item => {
        if (item.shipping && item.shipping.type === 'paid') {
            if (item.shipping.price > totalShipping) {
                totalShipping = item.shipping.price;
            }
        }
    });
    
    return totalShipping;
}

// ===== FUNCIONES DE PERSISTENCIA =====
function saveToStorage() {
    const dataToSave = {
        emailConfig: emailConfig,
        paypalConfig: paypalConfig,
        users: users,
        products: products,
        deliveryPresets: deliveryPresets,
        sales: sales,
        lang: lang,
        curr: curr,
        selectedCategory: selectedCategory
    };
    try {
        localStorage.setItem('miniTiendaData', JSON.stringify(dataToSave));
    } catch (error) {
        console.error('Error guardando datos:', error);
    }
}

function loadFromStorage() {
    try {
        const savedData = localStorage.getItem('miniTiendaData');
        if (savedData) {
            const data = JSON.parse(savedData);
            
            emailConfig = {...emailConfig, ...(data.emailConfig || {})};
            paypalConfig = {...paypalConfig, ...(data.paypalConfig || {})};
            
            if (data.deliveryPresets && data.deliveryPresets.length > 0) {
                deliveryPresets = data.deliveryPresets;
            }
            
            if (data.users && data.users.length > 0) users = data.users;
            if (data.products && data.products.length > 0) {
                products = data.products.map(p => ({
                    ...p,
                    shipping: p.shipping || {type: 'free', price: 0},
                    delivery: p.delivery || {type: 'custom', minDays: 7, maxDays: 15, origin: 'No especificado'},
                    source: p.source || {platform: '', url: '', costPrice: 0, notes: ''},
                    category: p.category || 'electronica'
                }));
            }
            if (data.sales) sales = data.sales;
            if (data.lang) lang = data.lang;
            if (data.curr) curr = data.curr;
            if (data.selectedCategory) selectedCategory = data.selectedCategory;
            
            return true;
        }
    } catch (error) {
        console.error('Error cargando datos:', error);
    }
    return false;
}

function fillFormFields() {
    if (emailConfig.adminEmail) {
        document.getElementById('admin-email').value = emailConfig.adminEmail;
        document.getElementById('emailjs-service').value = emailConfig.emailjsServiceId || '';
        document.getElementById('emailjs-template').value = emailConfig.emailjsTemplateId || '';
        document.getElementById('emailjs-template-confirm').value = emailConfig.emailjsTemplateConfirm || '';
        document.getElementById('emailjs-public-key').value = emailConfig.emailjsPublicKey || '';
    }
    
    if (paypalConfig.clientId !== 'ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn') {
        document.getElementById('paypal-client-id').value = paypalConfig.clientId;
        document.getElementById('paypal-mode').value = paypalConfig.mode;
    }
    
    document.getElementById('ls').value = lang;
    document.getElementById('cs').value = curr;
}

function exportData() {
    const dataToExport = {
        emailConfig: emailConfig,
        paypalConfig: paypalConfig,
        users: users.filter(u => u.role !== 'admin'),
        products: products,
        deliveryPresets: deliveryPresets,
        sales: sales,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(dataToExport, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `minitienda-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showAlert('📥 Datos exportados exitosamente', 'success');
}

function importData() {
    document.getElementById('import-file').click();
}

function handleImport(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (confirm('¿Estás seguro de que quieres importar estos datos?')) {
                if (importedData.emailConfig) emailConfig = {...emailConfig, ...importedData.emailConfig};
                if (importedData.paypalConfig) paypalConfig = {...paypalConfig, ...importedData.paypalConfig};
                if (importedData.deliveryPresets) deliveryPresets = importedData.deliveryPresets;
                
                if (importedData.users) {
                    const adminUser = users.find(u => u.role === 'admin');
                    users = [adminUser, ...importedData.users];
                }
                if (importedData.products) {
                    products = importedData.products.map(p => ({
                        ...p,
                        shipping: p.shipping || {type: 'free', price: 0},
                        delivery: p.delivery || {type: 'custom', minDays: 7, maxDays: 15, origin: 'No especificado'},
                        source: p.source || {platform: '', url: '', costPrice: 0, notes: ''},
                        category: p.category || 'electronica'
                    }));
                }
                if (importedData.sales) sales = importedData.sales;
                
                saveToStorage();
                fillFormFields();
                loadProducts();
                loadCategories();
                loadDeliveryPresets();
                updateProductDeliverySelect();
                if (user?.role === 'admin') loadAdmin();
                
                showAlert('📤 Datos importados exitosamente', 'success');
            }
        } catch (error) {
            console.error('Error importando datos:', error);
            showAlert('❌ Error importando archivo', 'error');
        }
    };
    reader.readAsText(file);
    input.value = '';
}

function clearAllData() {
    if (confirm('⚠️ ¿Estás seguro de que quieres borrar TODOS los datos?')) {
        if (confirm('🚨 ÚLTIMA CONFIRMACIÓN: Se borrarán productos, usuarios, configuraciones, presets y ventas. ¿Continuar?')) {
            localStorage.removeItem('miniTiendaData');
            localStorage.removeItem('wixMiniTiendaDesign');
            location.reload();
        }
    }
}

// ===== FUNCIONES DE EMAIL Y ACTIVACIÓN =====
function generateActivationCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}

function initEmailJS() {
    if (emailConfig.emailjsPublicKey) {
        emailjs.init(emailConfig.emailjsPublicKey);
        updateEmailStatus();
    }
}

async function sendConfirmationEmail(userEmail, userName, activationCode) {
    if (!emailConfig.emailjsServiceId || !emailConfig.emailjsTemplateConfirm || !emailConfig.emailjsPublicKey) {
        console.warn('EmailJS confirmación no está configurado completamente');
        return false;
    }

    try {
        const templateParams = {
            to_email: userEmail,
            from_name: 'MiniTienda',
            user_name: userName,
            user_email: userEmail,
            activation_code: activationCode,
            confirmation_date: new Date().toLocaleString()
        };

        const response = await emailjs.send(
            emailConfig.emailjsServiceId,
            emailConfig.emailjsTemplateConfirm,
            templateParams
        );

        console.log('Email de confirmación enviado:', response);
        return true;
    } catch (error) {
        console.error('Error enviando email de confirmación:', error);
        return false;
    }
}

async function testConfirmationEmail() {
    const testCode = generateActivationCode();
    
    showAlert('Enviando email de confirmación de prueba...', 'success');
    
    const success = await sendConfirmationEmail(
        emailConfig.adminEmail,
        'Usuario de Prueba',
        testCode
    );
    
    if (success) {
        showAlert(`✅ Email de confirmación enviado! Código: ${testCode}`, 'success');
    } else {
        showAlert('❌ Error enviando email de confirmación', 'error');
    }
}

function activateAccount() {
    const inputCode = document.getElementById('activation-code').value.trim().toUpperCase();
    
    if (!inputCode) {
        showAlert(lang==='es'?'Ingresa el código de activación':'Enter activation code', 'error');
        return;
    }
    
    const userToActivate = users.find(u => u.activationCode === inputCode && !u.isActive);
    
    if (userToActivate) {
        userToActivate.isActive = true;
        userToActivate.activationCode = '';
        
        saveToStorage();
        
        showAlert(lang==='es'?'¡Cuenta activada exitosamente!':'Account activated successfully!', 'success');
        
        setTimeout(() => {
            showSection('login');
        }, 2000);
    } else {
        showAlert(lang==='es'?'Código de activación inválido':'Invalid activation code', 'error');
    }
}

async function sendPurchaseNotification(orderDetails) {
    if (!emailConfig.emailjsServiceId || !emailConfig.emailjsTemplateId || !emailConfig.emailjsPublicKey) {
        console.warn('EmailJS no está configurado completamente');
        return false;
    }

    try {
        const templateParams = {
            to_email: emailConfig.adminEmail,
            from_name: 'MiniTienda',
            customer_name: orderDetails.customerName,
            customer_email: orderDetails.customerEmail,
            customer_phone: orderDetails.customerPhone,
            customer_address: orderDetails.customerAddress,
            customer_cedula: orderDetails.customerCedula,
            order_id: orderDetails.orderId,
            order_date: orderDetails.orderDate,
            total_amount: orderDetails.totalAmount,
            currency: orderDetails.currency,
            items_list: orderDetails.itemsList,
            shipping_cost: orderDetails.shippingCost,
            delivery_info: orderDetails.deliveryInfo || 'No especificado',
            payment_method: 'PayPal',
            transaction_id: orderDetails.transactionId || 'N/A'
        };

        const response = await emailjs.send(
            emailConfig.emailjsServiceId,
            emailConfig.emailjsTemplateId,
            templateParams
        );

        console.log('Email enviado exitosamente:', response);
        return true;
    } catch (error) {
        console.error('Error enviando email:', error);
        return false;
    }
}

async function testEmail() {
    const testOrder = {
        customerName: 'Cliente de Prueba',
        customerEmail: 'cliente@test.com',
        customerPhone: '+506-8888-8888',
        customerAddress: 'Dirección de prueba, San José, Costa Rica',
        customerCedula: '1-1234-5678',
        orderId: 'TEST-' + Date.now(),
        orderDate: new Date().toLocaleString(),
        totalAmount: '99.99',
        currency: 'USD',
        itemsList: 'Laptop Gaming x1 - $899.99\nMouse RGB x1 - $49.99',
        shippingCost: '5.99',
        deliveryInfo: 'Entrega: 7-15 días hábiles desde China',
        transactionId: 'TEST-TRANSACTION'
    };

    showAlert('Enviando email de prueba...', 'success');
    
    const success = await sendPurchaseNotification(testOrder);
    
    if (success) {
        showAlert('✅ Email de prueba enviado exitosamente!', 'success');
    } else {
        showAlert('❌ Error enviando email de prueba', 'error');
    }
}

function saveEmailConfig() {
    emailConfig.adminEmail = document.getElementById('admin-email').value;
    emailConfig.service = document.getElementById('email-service').value;
    emailConfig.emailjsServiceId = document.getElementById('emailjs-service').value;
    emailConfig.emailjsTemplateId = document.getElementById('emailjs-template').value;
    emailConfig.emailjsTemplateConfirm = document.getElementById('emailjs-template-confirm').value;
    emailConfig.emailjsPublicKey = document.getElementById('emailjs-public-key').value;

    if (emailConfig.emailjsPublicKey) {
        initEmailJS();
    }

    saveToStorage();
    showAlert('✅ Configuración de email guardada!', 'success');
    updateEmailStatus();
}

function updateEmailStatus() {
    const status = document.getElementById('email-status');
    if (emailConfig.emailjsServiceId && emailConfig.emailjsTemplateId && emailConfig.emailjsPublicKey) {
        const confirmStatus = emailConfig.emailjsTemplateConfirm ? ' + Confirmación' : '';
        status.innerHTML = `✅ Configurado (EmailJS${confirmStatus})`;
        status.style.color = '#27ae60';
    } else {
        status.innerHTML = '❌ No configurado';
        status.style.color = '#e74c3c';
    }
}

function updateAccountStatus() {
    const statusDiv = document.getElementById('account-status');
    const statusText = document.getElementById('status-text');
    
    if (user && user.role !== 'admin') {
        statusDiv.classList.remove('hidden');
        if (user.isActive) {
            statusDiv.className = 'account-status status-active';
            statusText.textContent = t[lang].accountActive;
        } else {
            statusDiv.className = 'account-status status-pending';
            statusText.textContent = t[lang].accountPending;
        }
    } else {
        statusDiv.classList.add('hidden');
    }
}

// ===== FUNCIONES DE INTERFAZ =====
function changeLang(){
    lang=document.getElementById('ls').value;
    updateTexts();
    document.getElementById('buy-now-btn').textContent = t[lang].buyNow;
    loadProducts();
    loadCategories();
    updateCart();
    updateAccountStatus();
    saveToStorage();
}

function changeCurr(){
    curr=document.getElementById('cs').value;
    updateCurrency();
    loadProducts();
    updateCart();
    updateUserInfo();
    saveToStorage();
}

function updateTexts(){
    Object.keys(t[lang]).forEach(k=>{
        const el=document.getElementById(k);
        if(el)el.textContent=t[lang][k];
    });
    document.getElementById('pl2').textContent=t[lang].pl;
}

function updateCurrency(){
    const s=curr==='USD'?'$':'₡';
    ['sy2','sy3','sy4','sy5'].forEach(id=>{
        const el=document.getElementById(id);
        if(el)el.textContent=s;
    });
}

function formatPrice(p){
    const c=curr==='CRC'?Math.round(p*rate).toLocaleString():p.toFixed(2);
    return `${curr==='USD'?'$':'₡'}${c}`;
}

function showSection(s){
    ['tienda','carrito','login','registro','admin','thank-you'].forEach(x=>document.getElementById(x).classList.add('hidden'));
    document.getElementById(s).classList.remove('hidden');
    if(s==='tienda'){loadProducts();loadCategories();}
    if(s==='carrito'){updateCart();renderPayPalButton();}
    if(s==='admin'&&user?.role==='admin'){loadAdmin();loadDeliveryPresets();updateProductDeliverySelect();}
}

function loadProducts(){
    const g=document.getElementById('pg');
    const filteredProducts = getFilteredProducts();
    
    g.innerHTML=filteredProducts.map(p=>{
        const categoryInfo = categories[p.category];
        const categoryName = categoryInfo ? categoryInfo.name[lang] : 'Sin categoría';
        
        const shippingText = p.shipping && p.shipping.type === 'paid' 
            ? `<div class="shipping-info shipping-paid">📦 ${t[lang].shippingCost} ${formatPrice(p.shipping.price)}</div>`
            : `<div class="shipping-info shipping-free">🆓 ${t[lang].freeShipping}</div>`;
        
        const deliveryInfo = getDeliveryInfo(p);
        const deliveryText = deliveryInfo 
            ? `<div class="delivery-info">🚚 ${t[lang].deliveryTime} ${deliveryInfo.minDays}-${deliveryInfo.maxDays} días hábiles${deliveryInfo.origin ? ` • ${deliveryInfo.origin}` : ''}</div>`
            : '';
        
        const sourceInfo = user?.role === 'admin' && p.source && p.source.platform 
            ? `<div class="admin-only-info">
                <span class="icon">🔗</span>
                <strong>Admin:</strong> ${p.source.platform.charAt(0).toUpperCase() + p.source.platform.slice(1)}
                ${p.source.costPrice ? ` • Costo: ${formatPrice(p.source.costPrice)}` : ''}
                ${p.source.notes ? ` • ${p.source.notes.substring(0, 50)}${p.source.notes.length > 50 ? '...' : ''}` : ''}
               </div>`
            : '';
        
        return `
        <div class="product" onclick="showDetail(${p.id})">
        <div class="product-category">${categoryName}</div>
        ${p.imageUrl?`<img src="${p.imageUrl}" class="pi" onerror="this.style.display='none';">`:`<div class="pi">📦 ${t[lang].noimg}</div>`}
        <h3>${p.name}</h3>
        <p>${p.desc}</p>
        <div class="price">${formatPrice(p.price)}</div>
        ${shippingText}
        ${deliveryText}
        ${sourceInfo}
        <div class="pb" onclick="event.stopPropagation()">
        <button class="btn" onclick="addToCart(${p.id})">🛒 ${t[lang].add}</button>
        ${p.paypalUrl?`<a href="${p.paypalUrl}" class="btn-buy-now" target="_blank">${t[lang].buy}</a>`:''}
        </div>
        ${user?.role==='admin'?`<div onclick="event.stopPropagation()">
        <button class="btn" onclick="editProduct(${p.id})" style="background:#f39c12;font-size:0.8rem">✏️ ${t[lang].edit}</button>
        <button class="btn btn-danger" onclick="deleteProduct(${p.id})" style="font-size:0.8rem">🗑️ ${t[lang].del}</button>
        </div>`:''}
        </div>
        `;
    }).join('');
}

function addToCart(id){
    if(!user){
        showAlert(lang==='es'?'Inicia sesión':'Sign in','error');
        return;
    }

    if(!user.isActive && user.role !== 'admin'){
        showAlert(t[lang].mustActivate,'error');
        return;
    }

    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    if(totalItems >= 15){
        showAlert(t[lang].cartLimit,'error');
        return;
    }
    const p=products.find(x=>x.id===id);
    const e=cart.find(x=>x.id===id);
    if(e)e.quantity+=1;
    else cart.push({...p,quantity:1});
    updateCartCount();
    showAlert(`${p.name} ${lang==='es'?'agregado':'added'}`,'success');
    saveToStorage();
}

function updateCart(){
    const c=document.getElementById('ci2');
    const subtotal=cart.reduce((s,i)=>s+(i.price*i.quantity),0);
    const shippingCost = calculateShipping(cart);
    const total = subtotal + shippingCost;
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    c.innerHTML=cart.map(i=>{
        const itemShipping = i.shipping && i.shipping.type === 'paid' 
            ? `<div class="cart-item-shipping">📦 Envío: ${formatPrice(i.shipping.price)}</div>`
            : `<div class="cart-item-shipping">🆓 Envío gratis</div>`;
        
        const deliveryInfo = getDeliveryInfo(i);
        const itemDelivery = deliveryInfo 
            ? `<div class="cart-item-delivery">🚚 ${deliveryInfo.minDays}-${deliveryInfo.maxDays} días hábiles</div>`
            : '';
        
        return `
        <div class="ci">
        <div>
            <strong>${i.name}</strong> - ${formatPrice(i.price)} x ${i.quantity}
            ${itemShipping}
            ${itemDelivery}
        </div>
        <div>
        <button class="btn" onclick="changeQty(${i.id},-1)">-</button>
        <button class="btn" onclick="changeQty(${i.id},1)">+</button>
        <button class="btn btn-danger" onclick="removeFromCart(${i.id})">${t[lang].del}</button>
        </div>
        </div>
        `;
    }).join('');
    
    // Actualizar totales
    document.getElementById('subtotal-amount').textContent=curr==='CRC'?Math.round(subtotal*rate).toLocaleString():subtotal.toFixed(2);
    document.getElementById('shipping-amount').textContent=curr==='CRC'?Math.round(shippingCost*rate).toLocaleString():shippingCost.toFixed(2);
    document.getElementById('tp').textContent=curr==='CRC'?Math.round(total*rate).toLocaleString():total.toFixed(2);
    document.getElementById('current-items').textContent=totalItems;
}

function changeQty(id,ch){
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    if(ch > 0 && totalItems >= 15){
        showAlert(t[lang].cartLimit,'error');
        return;
    }
    const i=cart.find(c=>c.id===id);
    if(i){
        i.quantity+=ch;
        if(i.quantity<=0)cart=cart.filter(c=>c.id!==id);
        updateCart();
        updateCartCount();
        renderPayPalButton();
        saveToStorage();
    }
}

function removeFromCart(id){
    cart=cart.filter(c=>c.id!==id);
    updateCart();
    updateCartCount();
    renderPayPalButton();
    saveToStorage();
}

function updateCartCount(){
    document.getElementById('cc').textContent=cart.reduce((s,i)=>s+i.quantity,0);
}

function triggerPayPalCheckout(){
    if(cart.length === 0){
        showAlert(lang==='es'?'Carrito vacío':'Cart empty','error');
        return;
    }

    if(!user.isActive && user.role !== 'admin'){
        showAlert(t[lang].mustActivate,'error');
        return;
    }

    document.getElementById('buy-now-btn').style.display = 'none';
    document.getElementById('paypal-button-container').style.display = 'block';
    renderPayPalButton();
}

function renderPayPalButton(){
    const container = document.getElementById('paypal-button-container');
    if(!container) return;
    container.innerHTML = '';
    if(cart.length === 0) {
        document.getElementById('buy-now-btn').style.display = 'block';
        container.style.display = 'none';
        return;
    }

    const subtotal = cart.reduce((s,i)=>s+(i.price*i.quantity),0);
    const shippingCost = calculateShipping(cart);
    const total = subtotal + shippingCost;
    const paypalTotal = curr === 'CRC' ? (total / rate).toFixed(2) : total.toFixed(2);

    if(window.paypal){
        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: paypalTotal,
                            currency_code: 'USD'
                        },
                        description: `${cart.length} ${t[lang].itemsInCart} - MiniTienda`
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    const deliveryInfoList = cart.map(item => {
                        const deliveryInfo = getDeliveryInfo(item);
                        return deliveryInfo ? 
                            `${item.name}: ${deliveryInfo.minDays}-${deliveryInfo.maxDays} días hábiles desde ${deliveryInfo.origin}` :
                            `${item.name}: Tiempo de entrega no especificado`;
                    }).join('\n');

                    const orderDetails = {
                        customerName: user.name,
                        customerEmail: user.email,
                        customerPhone: user.phone,
                        customerAddress: user.address,
                        customerCedula: user.cedula,
                        orderId: data.orderID,
                        orderDate: new Date().toLocaleString(),
                        totalAmount: paypalTotal,
                        currency: 'USD',
                        itemsList: cart.map(item => `${item.name} x${item.quantity} - $${item.price.toFixed(2)}`).join('\n'),
                        shippingCost: shippingCost.toFixed(2),
                        deliveryInfo: deliveryInfoList,
                        transactionId: details.id
                    };

                    sendPurchaseNotification(orderDetails);

                    sales += total;
                    cart = [];
                    updateCart();
                    updateCartCount();
                    document.getElementById('buy-now-btn').style.display = 'block';
                    document.getElementById('paypal-button-container').style.display = 'none';
                    showAlert(`${lang==='es'?'¡Pago PayPal exitoso!':'PayPal payment successful!'} - ${details.payer.name.given_name}`, 'success');
                    if(user?.role==='admin') loadAdmin();
                    saveToStorage();
                });
            },
            onCancel: function(data) {
                document.getElementById('buy-now-btn').style.display = 'block';
                document.getElementById('paypal-button-container').style.display = 'none';
                showAlert(lang==='es'?'Pago cancelado':'Payment cancelled','error');
            },
            onError: function(err) {
                document.getElementById('buy-now-btn').style.display = 'block';
                document.getElementById('paypal-button-container').style.display = 'none';
                showAlert(lang==='es'?'Error en el pago':'Payment error','error');
                console.error('PayPal error:', err);
            },
            style: {
                color: 'blue',
                shape: 'rect',
                label: 'paypal',
                height: 50,
                layout: 'vertical'
            }
        }).render('#paypal-button-container');
    } else {
        showAlert('PayPal no disponible','error');
    }
}

function savePayPalConfig(){
    const clientId = document.getElementById('paypal-client-id').value;
    const mode = document.getElementById('paypal-mode').value;
    if(!clientId){
        showAlert('Client ID requerido','error');
        return;
    }
    paypalConfig = {clientId, mode};
    document.getElementById('paypal-status').innerHTML = `✅ Configurado (${mode})`;
    showAlert(`Configuración PayPal guardada - Modo: ${mode}. Recarga la página para aplicar cambios.`,'success');
    saveToStorage();
}

function login(){
    const email=document.getElementById('le').value;
    const pass=document.getElementById('lp').value;
    const u=users.find(x=>x.email===email&&x.password===pass);
    if(u){
        user=u;
        updateUserInfo();
        updateAccountStatus();
        updateWixEditorVisibility();
        showSection('tienda');
        showAlert(`${t[lang].welcome}, ${u.name}!`,'success');
    }else{
        showAlert(lang==='es'?'Credenciales incorrectas':'Wrong credentials','error');
    }
}

function togglePassword(inputId, toggleIcon) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        toggleIcon.textContent = '🙈';
    } else {
        input.type = 'password';
        toggleIcon.textContent = '👁️';
    }
}

function register(){
    const name=document.getElementById('rn').value.trim();
    const email=document.getElementById('re').value.trim();
    const pass=document.getElementById('rp').value;
    const countryCode=document.getElementById('country-code').value;
    const phone=document.getElementById('rph').value.trim();
    const cedula=document.getElementById('cedula').value.trim();
    const address=document.getElementById('address').value.trim();

    if(!name||!email||!pass||!phone||!cedula||!address){
        showAlert(lang==='es'?'Todos los campos son requeridos':'All fields are required','error');
        return;
    }

    if(users.find(u=>u.email===email)){
        showAlert(lang==='es'?'Email ya existe':'Email already exists','error');
        return;
    }

    const activationCode = generateActivationCode();

    const fullPhone = `${countryCode}-${phone}`;
    const newUser = {
        id:users.length+1,
        name,
        email,
        password:pass,
        role:'customer',
        phone:fullPhone,
        cedula,
        address,
        isActive: false,
        activationCode: activationCode
    };

    users.push(newUser);
    saveToStorage();

    sendConfirmationEmail(email, name, activationCode);

    document.getElementById('ty-email').textContent = email;
    showSection('thank-you');

    ['rn','re','rp','rph','cedula','address'].forEach(id => document.getElementById(id).value='');
}

function logout(){
    user=null;
    cart=[];
    selectedCategory='';
    updateUserInfo();
    updateWixEditorVisibility();
    updateCartCount();
    showSection('tienda');
    showAlert(lang==='es'?'Cerrado':'Logged out','success');
}

function updateUserInfo(){
    if(user){
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('wt').textContent=`${t[lang].welcome}, ${user.name}`;
        document.getElementById('lb').classList.add('hidden');
        document.getElementById('ob').classList.remove('hidden');
        if(user.role==='admin')document.getElementById('ab').classList.remove('hidden');
    }else{
        document.getElementById('userInfo').classList.add('hidden');
        document.getElementById('lb').classList.remove('hidden');
        document.getElementById('ob').classList.add('hidden');
        document.getElementById('ab').classList.add('hidden');
    }
    updateWixEditorVisibility();
}

function loadAdmin(){
    document.getElementById('tps').textContent=products.length;
    document.getElementById('tus').textContent=users.length-1;
    document.getElementById('tus-active').textContent=users.filter(u=>u.isActive && u.role!=='admin').length;
    document.getElementById('ts').textContent=curr==='CRC'?Math.round(sales*rate).toLocaleString():sales.toFixed(2);
    document.getElementById('paypal-status').innerHTML = paypalConfig.clientId !== 'ARiqSNQ-c7ORV5f5P8FPcDzQrwiazstmxY6-n2AB4y7IndGYwQU5KjUNnE7McQhmwGwoUTCF250i_YUn' ? 
    `✅ Configurado (${paypalConfig.mode})` : '✅ Configurado (live)';
    document.getElementById('delivery-presets-count').textContent = deliveryPresets.length;
    document.getElementById('categories-count').textContent = Object.keys(categories).length;
    updateEmailStatus();
}

function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    const file = input.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
            <img src="${e.target.result}" alt="Preview">
            <button class="remove-image" onclick="removeImage('${input.id}', '${previewId}')" title="Eliminar imagen">×</button>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = '<div class="placeholder">📦 Vista previa de la imagen</div>';
    }
}

function removeImage(inputId, previewId) {
    document.getElementById(inputId).value = '';
    document.getElementById(previewId).innerHTML = '<div class="placeholder">📦 Vista previa de la imagen</div>';
}

function convertImageToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

function addProduct(){
    const name=document.getElementById('apn').value;
    const desc=document.getElementById('apd').value;
    const price=parseFloat(document.getElementById('app').value);
    const urlImg=document.getElementById('api').value;
    const paypal=document.getElementById('apy').value;
    const fileInput=document.getElementById('product-image');
    const category=document.getElementById('product-category').value;
    
    const sourcePlatform = document.getElementById('product-source-platform').value;
    const sourceUrl = document.getElementById('product-source-url').value;
    const costPrice = parseFloat(document.getElementById('product-cost-price').value) || 0;
    const privateNotes = document.getElementById('product-private-notes').value.trim();
    
    const shippingType = document.querySelector('input[name="shipping-type"]:checked').value;
    const shippingPrice = shippingType === 'paid' ? parseFloat(document.getElementById('shipping-price').value) || 0 : 0;

    const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
    let delivery;

    if (deliveryType === 'preset') {
        const presetId = document.getElementById('product-delivery-preset').value;
        if (!presetId) {
            showAlert('Selecciona un preset de entrega o usa configuración personalizada', 'error');
            return;
        }
        delivery = { type: 'preset', presetId };
    } else {
        const minDays = parseInt(document.getElementById('custom-delivery-min').value);
        const maxDays = parseInt(document.getElementById('custom-delivery-max').value);
        const origin = document.getElementById('custom-delivery-origin').value.trim();

        if (!minDays || !maxDays || !origin) {
            showAlert('Completa todos los campos de entrega personalizada', 'error');
            return;
        }

        if (minDays >= maxDays) {
            showAlert('Los días máximos deben ser mayores que los mínimos', 'error');
            return;
        }

        delivery = { type: 'custom', minDays, maxDays, origin };
    }

    if(!name||!desc||!price||!category){
        showAlert('Campos requeridos: nombre, descripción, precio y categoría','error');
        return;
    }

    if(shippingType === 'paid' && !shippingPrice){
        showAlert('Debes especificar el precio de envío','error');
        return;
    }

    const shipping = {
        type: shippingType,
        price: shippingPrice
    };

    const source = {
        platform: sourcePlatform,
        url: sourceUrl,
        costPrice: costPrice,
        notes: privateNotes
    };

    if(fileInput.files[0]) {
        convertImageToBase64(fileInput.files[0])
        .then(base64Image => {
            const newProduct = {
                id: Date.now(),
                name,
                desc,
                price,
                imageUrl: base64Image,
                paypalUrl: paypal || '',
                category: category,
                shipping: shipping,
                delivery: delivery,
                source: source
            };
            products.push(newProduct);
            clearProductForm();
            showAlert('Producto agregado con imagen, categoría, envío, entrega y fuente configurados','success');
            loadAdmin();
            loadProducts();
            loadCategories();
            saveToStorage();
        })
        .catch(error => {
            console.error('Error convirtiendo imagen:', error);
            showAlert('Error procesando imagen','error');
        });
    } else if(urlImg) {
        const newProduct = {
            id: Date.now(),
            name,
            desc,
            price,
            imageUrl: urlImg,
            paypalUrl: paypal || '',
            category: category,
            shipping: shipping,
            delivery: delivery,
            source: source
        };
        products.push(newProduct);
        clearProductForm();
        showAlert('Producto agregado con URL, categoría, envío, entrega y fuente configurados','success');
        loadAdmin();
        loadProducts();
        loadCategories();
        saveToStorage();
    } else {
        const newProduct = {
            id: Date.now(),
            name,
            desc,
            price,
            imageUrl: '',
            paypalUrl: paypal || '',
            category: category,
            shipping: shipping,
            delivery: delivery,
            source: source
        };
        products.push(newProduct);
        clearProductForm();
        showAlert('Producto agregado con configuración completa','success');
        loadAdmin();
        loadProducts();
        loadCategories();
        saveToStorage();
    }
}

function clearProductForm() {
    document.getElementById('apn').value='';
    document.getElementById('apd').value='';
    document.getElementById('app').value='';
    document.getElementById('api').value='';
    document.getElementById('apy').value='';
    document.getElementById('product-image').value='';
    document.getElementById('image-preview').innerHTML='<div class="placeholder">📦 Vista previa de la imagen</div>';
    document.getElementById('product-category').value='';
    
    document.getElementById('product-source-platform').value='';
    document.getElementById('product-source-url').value='';
    document.getElementById('product-cost-price').value='';
    document.getElementById('product-private-notes').value='';
    
    document.getElementById('shipping-free').checked = true;
    document.getElementById('shipping-paid').checked = false;
    document.getElementById('shipping-price').value = '';
    document.getElementById('shipping-price-container').classList.add('hidden');

    document.getElementById('delivery-preset-option').checked = true;
    document.getElementById('delivery-custom-option').checked = false;
    document.getElementById('product-delivery-preset').value = '';
    document.getElementById('custom-delivery-min').value = '';
    document.getElementById('custom-delivery-max').value = '';
    document.getElementById('custom-delivery-origin').value = '';
    document.getElementById('delivery-preset-selector').classList.remove('hidden');
    document.getElementById('delivery-custom-inputs').classList.add('hidden');
}

function editProduct(id){
    const p=products.find(x=>x.id===id);
    if(!p)return;
    
    document.getElementById('apn').value=p.name;
    document.getElementById('apd').value=p.desc;
    document.getElementById('app').value=p.price;
    document.getElementById('api').value=p.imageUrl.startsWith('data:') ? '' : p.imageUrl;
    document.getElementById('apy').value=p.paypalUrl;
    document.getElementById('product-category').value=p.category || '';

    if(p.source){
        document.getElementById('product-source-platform').value=p.source.platform || '';
        document.getElementById('product-source-url').value=p.source.url || '';
        document.getElementById('product-cost-price').value=p.source.costPrice || '';
        document.getElementById('product-private-notes').value=p.source.notes || '';
    }

    if(p.shipping && p.shipping.type === 'paid'){
        document.getElementById('shipping-paid').checked = true;
        document.getElementById('shipping-free').checked = false;
        document.getElementById('shipping-price').value = p.shipping.price;
        document.getElementById('shipping-price-container').classList.remove('hidden');
    } else {
        document.getElementById('shipping-free').checked = true;
        document.getElementById('shipping-paid').checked = false;
        document.getElementById('shipping-price-container').classList.add('hidden');
    }

    if(p.delivery && p.delivery.type === 'preset'){
        document.getElementById('delivery-preset-option').checked = true;
        document.getElementById('delivery-custom-option').checked = false;
        document.getElementById('product-delivery-preset').value = p.delivery.presetId;
        document.getElementById('delivery-preset-selector').classList.remove('hidden');
        document.getElementById('delivery-custom-inputs').classList.add('hidden');
    } else if(p.delivery && p.delivery.type === 'custom'){
        document.getElementById('delivery-preset-option').checked = false;
        document.getElementById('delivery-custom-option').checked = true;
        document.getElementById('custom-delivery-min').value = p.delivery.minDays;
        document.getElementById('custom-delivery-max').value = p.delivery.maxDays;
        document.getElementById('custom-delivery-origin').value = p.delivery.origin;
        document.getElementById('delivery-preset-selector').classList.add('hidden');
        document.getElementById('delivery-custom-inputs').classList.remove('hidden');
    }

    if(p.imageUrl) {
        document.getElementById('image-preview').innerHTML = `
        <img src="${p.imageUrl}" alt="Preview">
        <button class="remove-image" onclick="removeImage('product-image', 'image-preview')" title="Eliminar imagen">×</button>
        `;
    }

    document.getElementById('apb').onclick=()=>{
        const fileInput=document.getElementById('product-image');
        const urlImg=document.getElementById('api').value;
        const category=document.getElementById('product-category').value;
        
        const sourcePlatform = document.getElementById('product-source-platform').value;
        const sourceUrl = document.getElementById('product-source-url').value;
        const costPrice = parseFloat(document.getElementById('product-cost-price').value) || 0;
        const privateNotes = document.getElementById('product-private-notes').value.trim();
        
        const shippingType = document.querySelector('input[name="shipping-type"]:checked').value;
        const shippingPrice = shippingType === 'paid' ? parseFloat(document.getElementById('shipping-price').value) || 0 : 0;

        const deliveryType = document.querySelector('input[name="delivery-type"]:checked').value;
        let delivery;

        if (deliveryType === 'preset') {
            const presetId = document.getElementById('product-delivery-preset').value;
            if (!presetId) {
                showAlert('Selecciona un preset de entrega', 'error');
                return;
            }
            delivery = { type: 'preset', presetId };
        } else {
            const minDays = parseInt(document.getElementById('custom-delivery-min').value);
            const maxDays = parseInt(document.getElementById('custom-delivery-max').value);
            const origin = document.getElementById('custom-delivery-origin').value.trim();

            if (!minDays || !maxDays || !origin) {
                showAlert('Completa todos los campos de entrega personalizada', 'error');
                return;
            }

            if (minDays >= maxDays) {
                showAlert('Los días máximos deben ser mayores que los mínimos', 'error');
                return;
            }

            delivery = { type: 'custom', minDays, maxDays, origin };
        }

        if(shippingType === 'paid' && !shippingPrice){
            showAlert('Debes especificar el precio de envío','error');
            return;
        }

        if(!category){
            showAlert('Selecciona una categoría','error');
            return;
        }

        const shipping = {
            type: shippingType,
            price: shippingPrice
        };

        const source = {
            platform: sourcePlatform,
            url: sourceUrl,
            costPrice: costPrice,
            notes: privateNotes
        };

        if(fileInput.files[0]) {
            convertImageToBase64(fileInput.files[0])
            .then(base64Image => {
                p.name=document.getElementById('apn').value;
                p.desc=document.getElementById('apd').value;
                p.price=parseFloat(document.getElementById('app').value);
                p.imageUrl=base64Image;
                p.paypalUrl=document.getElementById('apy').value;
                p.category=category;
                p.shipping=shipping;
                p.delivery=delivery;
                p.source=source;
                showAlert('Producto actualizado con nueva imagen','success');
                loadProducts();
                loadCategories();
                loadAdmin();
                clearProductForm();
                document.getElementById('apb').onclick=addProduct;
                saveToStorage();
            });
        } else {
            p.name=document.getElementById('apn').value;
            p.desc=document.getElementById('apd').value;
            p.price=parseFloat(document.getElementById('app').value);
            p.imageUrl=urlImg || p.imageUrl;
            p.paypalUrl=document.getElementById('apy').value;
            p.category=category;
            p.shipping=shipping;
            p.delivery=delivery;
            p.source=source;
            showAlert('Producto actualizado','success');
            loadProducts();
            loadCategories();
            loadAdmin();
            clearProductForm();
            document.getElementById('apb').onclick=addProduct;
            saveToStorage();
        }
    };
}

function deleteProduct(id){
    if(confirm('¿Eliminar producto?')){
        products=products.filter(p=>p.id!==id);
        loadProducts();
        loadCategories();
        loadAdmin();
        showAlert('Producto eliminado','success');
        saveToStorage();
    }
}

function showDetail(id){
    const p=products.find(x=>x.id===id);
    if(!p)return;
    
    const categoryInfo = categories[p.category];
    const categoryName = categoryInfo ? categoryInfo.name[lang] : 'Sin categoría';
    
    const shippingInfo = p.shipping && p.shipping.type === 'paid' 
        ? `<div style="color:#e67e22;margin:0.5rem 0;">📦 ${t[lang].shippingCost} ${formatPrice(p.shipping.price)}</div>`
        : `<div style="color:#27ae60;margin:0.5rem 0;">🆓 ${t[lang].freeShipping}</div>`;
    
    const deliveryInfo = getDeliveryInfo(p);
    const deliveryText = deliveryInfo 
        ? `<div style="color:#8e44ad;margin:0.5rem 0;">🚚 ${t[lang].deliveryTime} ${deliveryInfo.minDays}-${deliveryInfo.maxDays} días hábiles${deliveryInfo.origin ? ` • ${deliveryInfo.origin}` : ''}</div>`
        : '';
    
    const adminSourceInfo = user?.role === 'admin' && p.source && p.source.platform 
        ? `<div style="background:#fff3cd;padding:0.75rem;margin:1rem 0;border-radius:4px;border-left:4px solid #f39c12;">
            <div style="font-weight:bold;color:#856404;margin-bottom:0.25rem;">🔗 Información de Admin:</div>
            <div style="color:#856404;font-size:0.9rem;">
                <strong>Plataforma:</strong> ${p.source.platform.charAt(0).toUpperCase() + p.source.platform.slice(1)}<br>
                ${p.source.url ? `<strong>URL:</strong> <a href="${p.source.url}" target="_blank" style="color:#856404;">Ver producto original</a><br>` : ''}
                ${p.source.costPrice ? `<strong>Costo:</strong> ${formatPrice(p.source.costPrice)}<br>` : ''}
                ${p.source.notes ? `<strong>Notas:</strong> ${p.source.notes}` : ''}
            </div>
        </div>`
        : '';
    
    document.getElementById('mc2').innerHTML=`
    <div style="text-align:center">
    ${p.imageUrl?`<img src="${p.imageUrl}" style="width:100%;max-height:300px;object-fit:contain;border-radius:4px;margin-bottom:1rem">`:`<div class="pi">📦 ${t[lang].noimg}</div>`}
    <h2>${p.name}</h2>
    <p>${p.desc}</p>
    <div style="background:#3498db;color:white;padding:0.25rem 0.75rem;border-radius:12px;display:inline-block;font-size:0.8rem;margin:0.5rem 0;">${categoryName}</div>
    <div style="font-size:2rem;font-weight:bold;color:#27ae60;margin:1rem 0">${formatPrice(p.price)}</div>
    ${shippingInfo}
    ${deliveryText}
    ${adminSourceInfo}
    <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;margin-bottom:1rem">
    ${user?`<button class="btn" onclick="addToCart(${p.id});closeModal()">🛒 ${t[lang].add}</button>`:`<p style="color:#e74c3c">${lang==='es'?'Inicia sesión':'Sign in'}</p>`}
    </div>
    ${p.paypalUrl?`<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #ddd">
    <p style="font-size:0.9rem;color:#666;margin-bottom:0.5rem">${t[lang].directPayment}</p>
    <a href="${p.paypalUrl}" class="btn-buy-now" target="_blank" style="font-size:0.9rem;">${t[lang].buy}</a>
    </div>`:''}
    </div>
    `;
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal').style.display='flex';
}

function closeModal(){
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('modal').style.display='none';
}

function showAlert(msg,type){
    const c=document.getElementById('alertContainer');
    const a=document.createElement('div');
    a.className=`alert alert-${type}`;
    a.textContent=msg;
    c.appendChild(a);
    setTimeout(()=>a.remove(),3000);
}

// ===== INICIALIZACIÓN =====
loadFromStorage();
loadWixDesignFromStorage();
loadProducts();
loadCategories();
updateTexts();
updateCurrency();
updateUserInfo();
updateWixEditorVisibility();
renderPayPalButton();
initEmailJS();
updateEmailStatus();
fillFormFields();
loadDeliveryPresets();
updateProductDeliverySelect();

document.getElementById('modal').addEventListener('click',e=>{
    if(e.target===document.getElementById('modal'))closeModal();
});

setInterval(() => {
    saveToStorage();
    saveWixDesignToStorage();
}, 30000);

console.log('🛒 MiniTienda con Editor Wix completamente cargada');
console.log('🎨 Funciones Wix disponibles:', {
    toggleWixEditor,
    addWixSection,
    applyWixTheme,
    saveWixDesign,
    loadWixDesign,
    resetWixDesign
});
</script>
</body>
</html>
